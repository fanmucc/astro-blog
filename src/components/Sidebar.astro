---
// src/components/Sidebar.astro - ä¾§è¾¹æ ç»„ä»¶
import Icon from "./Icon.astro";
import type { MenuItem } from "../utils/menu";

export interface Props {
	menuTree: MenuItem[];
	currentPath: string;
	showMainMenu?: boolean;
	showSubMenu?: boolean;
}

const {
	menuTree,
	currentPath,
	showMainMenu = true,
	showSubMenu = true,
} = Astro.props;

console.log(menuTree);

// æ‰¾åˆ°å½“å‰æ¿€æ´»çš„ä¸»èœå•
const currentMainMenu = menuTree.find((item) =>
	currentPath.startsWith(item.path)
);
---

<aside class='sidebar'>
	<div class='sidebar-content'>
		<!-- ä¸»èœå• -->
		{
			showMainMenu && (
				<div class='main-menu-section'>
					<nav class='main-menu-nav' id='main-menu'>
						{menuTree.map((menuItem) => (
							<a
								href={menuItem.path}
								data-menu={menuItem.value}
								data-path={menuItem.path}
								data-astro-prefetch
								class={`main-menu-item ${
									currentPath.startsWith(menuItem.path) ? "active" : ""
								}`}
							>
								{menuItem.icon && (
									<span class='main-menu-icon'>
										<Icon name={menuItem.icon as any} />
									</span>
								)}
								<span class='main-menu-text'>{menuItem.label}</span>
							</a>
						))}
					</nav>
				</div>
			)
		}

		<!-- å­èœå• -->
		{
			showSubMenu &&
				currentMainMenu &&
				currentMainMenu.children &&
				currentMainMenu.children.length > 0 && (
					<div class='submenu-section'>
						{/* <div class='submenu-header'>
							<h3 class='submenu-title'>{currentMainMenu.label} - å­èœå•</h3>
						</div> */}

						<div class='submenu-content'>
							{(() => {
								// æ£€æŸ¥å½“å‰ä¸»èœå•æ˜¯å¦æœ‰ä»»ä½•åŒ…å«äºŒçº§é¡µé¢çš„é¡¹ç›®
								const hasAnySubMenu = currentMainMenu.children.some(
									(item) => item.children && item.children.length > 0
								);

								return currentMainMenu.children.map((subItem) => {
									const isActive =
										currentPath === subItem.path ||
										currentPath.startsWith(subItem.path + "/");
									const hasChildren =
										subItem.children && subItem.children.length > 0;

									// æ£€æŸ¥æ˜¯å¦åº”è¯¥å±•å¼€ï¼šå½“å‰è·¯å¾„åŒ¹é…æˆ–è€…æ˜¯é€šè¿‡ä¸»èœå•ç›´æ¥è¿›å…¥
									const isMainMenuAccess = currentPath === currentMainMenu.path;
									const shouldExpand = isActive || isMainMenuAccess;

									return (
										<div class='submenu-group'>
											<a
												href={subItem.path}
												data-astro-prefetch
												class={`submenu-group-header ${isActive ? "active" : ""}`}
											>
												{hasChildren ? (
													<span
														class={`submenu-expand-arrow ${shouldExpand ? "expanded" : ""}`}
													>
														<svg
															width='20'
															height='20'
															viewBox='0 0 24 24'
															fill='none'
															stroke='currentColor'
															stroke-width='2'
														>
															<path d='m9 18 6-6-6-6' />
														</svg>
													</span>
												) : hasAnySubMenu ? (
													<span class='submenu-expand-arrow submenu-expand-placeholder'>
														{/* éšè—çš„å ä½å›¾æ ‡ï¼Œä¿æŒå¸ƒå±€ä¸€è‡´ */}
													</span>
												) : null}
												<span class='submenu-group-title'>{subItem.label}</span>
											</a>

											{hasChildren && shouldExpand && subItem.children && (
												<div class='submenu-children'>
													{subItem.children.map((childItem) => (
														<div class='submenu-item'>
															<a
																href={childItem.path}
																data-astro-prefetch
																class={`submenu-item-link ${
																	currentPath === childItem.path ? "active" : ""
																}`}
															>
																<div
																	class={`submenu-indicator ${
																		currentPath === childItem.path
																			? "active"
																			: ""
																	}`}
																/>
																<span class='submenu-item-text'>
																	{childItem.label}
																</span>
															</a>
														</div>
													))}
												</div>
											)}
										</div>
									);
								});
							})()}
						</div>
					</div>
				)
		}

		<!-- ç©ºçŠ¶æ€æç¤º -->
		<!-- {
			showSubMenu &&
				(!currentMainMenu ||
					!currentMainMenu.children ||
					currentMainMenu.children.length === 0) && (
					<div class='submenu-section'>
						<div class='submenu-header'>
							<h3 class='submenu-title'>å­èœå•</h3>
						</div>
						<div class='submenu-placeholder'>
							<p class='placeholder-text'>é€‰æ‹©ä¸Šæ–¹èœå•æŸ¥çœ‹å­é€‰é¡¹</p>
						</div>
					</div>
				)
		} -->
	</div>
</aside>

<style>
	/* ä¾§è¾¹æ åŸºç¡€æ ·å¼ */
	.sidebar {
		position: fixed;
		top: 4rem; /* headeré«˜åº¦ */
		left: 0;
		width: 16rem;
		height: calc(100vh - 4rem); /* æœ‰headeræ—¶çš„é«˜åº¦ */
		border-right: 1px solid var(--a-sidebar-border);
		background-color: var(--a-sidebar-bg);
		display: flex;
		flex-direction: column;
		overflow: hidden;
		z-index: 10; /* ç¡®ä¿åœ¨å†…å®¹ä¹‹ä¸Šï¼Œä½†åœ¨header(z-index:50)ä¹‹ä¸‹ */
		/* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
		transition:
			top 0.3s ease,
			height 0.3s ease;
	}

	/* æ— headeræ—¶çš„ä¾§è¾¹æ ä½ç½®å’Œé«˜åº¦ */
	.main-layout.no-header .sidebar {
		top: 0;
		height: 100vh;
	}

	.sidebar-content {
		flex: 1 1 auto;
		overflow-y: auto !important;
		overflow-x: hidden !important;
		padding: 1rem 0.5rem;
		scrollbar-width: thin;
		scrollbar-color: var(--g-border) transparent;
		/* ç¡®ä¿èƒ½å¤Ÿæ­£ç¡®æ»šåŠ¨ */
		min-height: 0 !important;
		max-height: 100% !important;
		/* å¹³æ»‘æ»šåŠ¨ */
		scroll-behavior: smooth;
		/* åœ¨ iOS ä¸Šå¯ç”¨æƒ¯æ€§æ»šåŠ¨ */
		-webkit-overflow-scrolling: touch;
	}

	.sidebar-content::-webkit-scrollbar {
		width: 4px;
	}

	.sidebar-content::-webkit-scrollbar-track {
		background: transparent;
	}

	.sidebar-content::-webkit-scrollbar-thumb {
		background: var(--g-border);
		border-radius: 2px;
		transition: background-color 0.2s ease;
	}

	.sidebar-content::-webkit-scrollbar-thumb:hover {
		background: rgba(var(--color-primary), 0.6);
	}

	/* ä¸»èœå•æ ·å¼ */
	.main-menu-section {
		background-color: var(--a-main-bg);
		border-radius: 0.5rem;
		padding: 0.5rem;
		margin-bottom: 1.5rem;
	}

	.main-menu-nav {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}

	.main-menu-item {
		display: flex;
		align-items: center;
		width: 100%;
		padding: 0.625rem 0.75rem;
		font-size: 0.875rem;
		font-weight: 500;
		background-color: var(--a-main-item-bg);
		color: var(--a-main-item-text);
		border-radius: 0.5rem;
		text-decoration: none;
		transition: all var(--transition-normal);
	}

	.main-menu-item:hover {
		background-color: rgb(var(--color-primary) / 0.2);
		color: var(--a-main-item-text-hover);
	}

	.main-menu-item.active {
		background-color: var(--a-main-item-bg-active);
		color: var(--a-main-item-text-active);
		box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
	}

	.main-menu-icon {
		margin-right: 0.75rem;
		height: 1.25rem;
		width: 1.25rem;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--a-main-icon);
	}

	.main-menu-item.active .main-menu-icon {
		color: var(--a-main-icon-active);
	}

	.main-menu-text {
		flex: 1;
	}

	/* å­èœå•å…¨å±€æ ·å¼ - ç¡®ä¿åŠ¨æ€ç”Ÿæˆçš„HTMLä¹Ÿèƒ½åº”ç”¨ */
	.submenu-section {
		padding: 0.5rem 1rem 0;
	}

	.submenu-content {
		display: flex;
		flex-direction: column;
		gap: 0.125rem;
	}

	/* å­èœå•ç»„ */
	.submenu-group {
		margin-bottom: 0.5rem;
	}

	.submenu-group-header {
		display: flex;
		align-items: center;
		padding: 0.75rem;
		cursor: pointer;
		border-radius: 0.375rem;
		text-decoration: none;
		transition: all var(--transition-fast);
		background-color: var(--a-sub-item-bg);
		width: 100%;
		text-align: left;
	}

	.submenu-group-header:hover {
		background-color: var(--a-sub-item-bg-hover);
	}

	.submenu-group-header.active {
		background-color: var(--a-sub-item-bg-active);
	}

	.submenu-expand-arrow {
		width: 1.5rem;
		height: 1.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--g-text-secondary);
		transition: transform var(--transition-fast);
		flex-shrink: 0;
	}

	.submenu-expand-arrow.expanded {
		transform: rotate(90deg);
	}

	.submenu-expand-placeholder {
		opacity: 0;
		pointer-events: none;
	}

	.submenu-group-title {
		margin-left: 0.25rem;
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--m-content-heading);
		flex: 1;
	}

	.submenu-group-header.active .submenu-group-title {
		color: var(--a-sub-item-text-active);
	}

	/* å­èœå•å­é¡¹ */
	.submenu-children {
		position: relative;
		margin-left: 0.75rem;
		margin-top: 0.25rem;
		/* æ·»åŠ èƒŒæ™¯è¿æ¥çº¿ */
		background: linear-gradient(
			to bottom,
			transparent 0%,
			var(--a-sub-border) 0.5rem,
			var(--a-sub-border) calc(100% - 0.5rem),
			transparent 100%
		);
		background-size: 1px 100%;
		background-repeat: no-repeat;
		background-position: 0.75rem 0;
	}

	.submenu-item {
		position: relative;
		margin-bottom: 0.125rem;
	}

	/* ä¸ºæ¯ä¸ªå­èœå•é¡¹æ·»åŠ æ°´å¹³è¿æ¥çº¿ */
	.submenu-item::before {
		content: "";
		position: absolute;
		left: 0.75rem;
		top: 50%;
		width: 0.75rem;
		height: 1px;
		background-color: var(--a-sub-border);
		transform: translateY(-50%);
		opacity: 0.6;
	}

	.submenu-item-link {
		display: block; /* æ”¹ä¸ºblockå¸ƒå±€ä»¥ä¾¿ç»å¯¹å®šä½ */
		padding: 0.75rem 0 0.75rem 1.5rem; /* å·¦ä¾§ç•™å‡ºæŒ‡ç¤ºå™¨ç©ºé—´ */
		margin-left: 1.5rem;
		text-decoration: none;
		transition: all var(--transition-fast);
		position: relative;
		z-index: 1; /* ç¡®ä¿é“¾æ¥åœ¨è¿æ¥çº¿ä¹‹ä¸Š */
	}

	.submenu-indicator {
		position: absolute;
		left: 0rem; /* å¯¹é½åˆ°å·¦ä¾§è¾¹æ¡†çš„ä½ç½® */
		top: 50%;
		transform: translateY(-50%);
		width: 1px; /* ä¸è¾¹æ¡†çº¿å®½åº¦ä¸€è‡´ */
		height: 1.5rem; /* é€‚å½“çš„é«˜åº¦ */
		background-color: var(--a-sub-border-active);
		transition: all var(--transition-fast);
		opacity: 0; /* é»˜è®¤éšè— */
		z-index: 2; /* ç¡®ä¿åœ¨è¿æ¥çº¿ä¹‹ä¸Š */
	}

	.submenu-item-link:hover .submenu-indicator {
		opacity: 1;
		background-color: var(--a-sub-border-active);
	}

	.submenu-indicator.active {
		opacity: 1;
		background-color: var(--a-sub-border-active);
	}

	.submenu-item-text {
		font-size: 0.875rem;
		color: var(--a-sub-item-text);
		transition: color var(--transition-fast);
		/* ç§»é™¤margin-leftï¼Œå› ä¸ºpaddingå·²ç»å¤„ç†äº†ç©ºé—´ */
	}

	.submenu-item-link:hover .submenu-item-text {
		color: var(--a-sub-item-text-hover);
	}

	.submenu-item-link.active .submenu-item-text {
		color: var(--a-sub-item-text-active);
		font-weight: 500;
	}

	/* ç©ºçŠ¶æ€ */
	.submenu-placeholder {
		padding: 1rem 0.75rem;
		text-align: center;
	}

	.placeholder-text {
		font-size: 0.75rem;
		color: var(--g-text-muted);
		margin: 0;
	}

	/* å“åº”å¼è®¾è®¡ */
	@media (max-width: 768px) {
		.sidebar {
			width: 14rem;
			top: 3.5rem; /* ç§»åŠ¨ç«¯headeré«˜åº¦è°ƒæ•´ */
			height: calc(100vh - 3.5rem);
		}

		.main-layout.no-header .sidebar {
			top: 0;
			height: 100vh;
		}

		.main-menu-item {
			padding: 0.5rem;
			font-size: 0.75rem;
		}

		.submenu-title {
			font-size: 0.75rem;
		}

		.submenu-group-title,
		.submenu-item-text {
			font-size: 0.75rem;
		}

		/* ç§»åŠ¨ç«¯æ»šåŠ¨æ¡ä¼˜åŒ– */
		.sidebar-content::-webkit-scrollbar {
			width: 2px;
		}
	}

	@media (min-width: 1280px) {
		.sidebar {
			width: 18rem;
		}
	}
</style>

<style is:global>
	/* å­èœå•å…¨å±€æ ·å¼ - ç¡®ä¿åŠ¨æ€ç”Ÿæˆçš„HTMLä¹Ÿèƒ½åº”ç”¨ */
	.submenu-section {
		padding: 0.5rem 1rem 0;
	}

	.submenu-content {
		display: flex;
		flex-direction: column;
		gap: 0.125rem;
	}

	/* å­èœå•ç»„ */
	.submenu-group {
		margin-bottom: 0.5rem;
	}

	.submenu-group-header {
		display: flex;
		align-items: center;
		padding: 0.75rem;
		cursor: pointer;
		border-radius: 0.375rem;
		text-decoration: none;
		transition: all var(--transition-fast);
		background-color: var(--a-sub-item-bg);
		width: 100%;
		text-align: left;
	}

	.submenu-group-header:hover {
		background-color: var(--a-sub-item-bg-hover);
	}

	.submenu-group-header.active {
		background-color: var(--a-sub-item-bg-active);
	}

	.submenu-expand-arrow {
		width: 1.5rem;
		height: 1.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--g-text-secondary);
		transition: transform var(--transition-fast);
		flex-shrink: 0;
	}

	.submenu-expand-arrow.expanded {
		transform: rotate(90deg);
	}

	.submenu-expand-placeholder {
		opacity: 0;
		pointer-events: none;
	}

	.submenu-group-title {
		margin-left: 0.25rem;
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--m-content-heading);
		flex: 1;
	}

	.submenu-group-header.active .submenu-group-title {
		color: var(--a-sub-item-text-active);
	}

	/* å­èœå•å­é¡¹ */
	.submenu-children {
		position: relative;
		margin-left: 0.75rem;
		margin-top: 0.25rem;
		/* æ·»åŠ èƒŒæ™¯è¿æ¥çº¿ */
		background: linear-gradient(
			to bottom,
			transparent 0%,
			var(--a-sub-border) 0.5rem,
			var(--a-sub-border) calc(100% - 0.5rem),
			transparent 100%
		);
		background-size: 1px 100%;
		background-repeat: no-repeat;
		background-position: 0.75rem 0;
	}

	.submenu-item {
		position: relative;
		margin-bottom: 0.125rem;
	}

	/* ä¸ºæ¯ä¸ªå­èœå•é¡¹æ·»åŠ æ°´å¹³è¿æ¥çº¿ */
	.submenu-item::before {
		content: "";
		position: absolute;
		left: 0.75rem;
		top: 50%;
		width: 0.75rem;
		height: 1px;
		background-color: var(--a-sub-border);
		transform: translateY(-50%);
		opacity: 0.6;
	}

	.submenu-item-link {
		display: block; /* æ”¹ä¸ºblockå¸ƒå±€ä»¥ä¾¿ç»å¯¹å®šä½ */
		padding: 0.75rem 0 0.75rem 0.75rem; /* å·¦ä¾§ç•™å‡ºæŒ‡ç¤ºå™¨ç©ºé—´ */
		margin-left: 1.5rem;
		text-decoration: none;
		transition: all var(--transition-fast);
		position: relative;
		z-index: 1; /* ç¡®ä¿é“¾æ¥åœ¨è¿æ¥çº¿ä¹‹ä¸Š */
	}

	.submenu-indicator {
		position: absolute;
		left: -0.75rem; /* å¯¹é½åˆ°å·¦ä¾§è¾¹æ¡†çš„ä½ç½® */
		top: 50%;
		transform: translateY(-50%);
		width: 1px; /* ä¸è¾¹æ¡†çº¿å®½åº¦ä¸€è‡´ */
		height: 1.5rem; /* é€‚å½“çš„é«˜åº¦ */
		background-color: var(--a-sub-border-active);
		transition: all var(--transition-fast);
		opacity: 0; /* é»˜è®¤éšè— */
		z-index: 2; /* ç¡®ä¿åœ¨è¿æ¥çº¿ä¹‹ä¸Š */
	}

	.submenu-item-link:hover .submenu-indicator {
		opacity: 1;
		background-color: var(--a-sub-border-active);
	}

	.submenu-indicator.active {
		opacity: 1;
		background-color: var(--a-sub-border-active);
	}

	.submenu-item-text {
		font-size: 0.875rem;
		color: var(--a-sub-item-text);
		transition: color var(--transition-fast);
		/* ç§»é™¤margin-leftï¼Œå› ä¸ºpaddingå·²ç»å¤„ç†äº†ç©ºé—´ */
	}

	.submenu-item-link:hover .submenu-item-text {
		color: var(--a-sub-item-text-hover);
	}

	.submenu-item-link.active .submenu-item-text {
		color: var(--a-sub-item-text-active);
		font-weight: 500;
	}
</style>

<script>
	// ç±»å‹å£°æ˜
	interface MenuTreeItem {
		label: string;
		path: string;
		children?: MenuTreeItem[];
		[key: string]: any;
	}

	declare global {
		interface Window {
			sidebarManager?: SidebarManager;
			SidebarManager: typeof SidebarManager;
		}
	}

	// å®¢æˆ·ç«¯ä¾§è¾¹æ ç®¡ç†å™¨
	class SidebarManager {
		private currentPath: string;
		private menuTree: MenuTreeItem[] | null;

		constructor() {
			this.currentPath = window.location.pathname;
			this.menuTree = null;
			this.init();
		}

		init() {
			// ä»æœåŠ¡ç«¯è·å–èœå•æ•°æ®
			this.extractMenuData();

			// ç›‘å¬è·¯ç”±å˜åŒ–
			this.setupRouteListener();

			// ç»‘å®šèœå•äº¤äº’äº‹ä»¶
			this.bindMenuEvents();
		}

		extractMenuData() {
			// ä»é¡µé¢ä¸­æå–èœå•æ•°æ®ï¼ˆé€šè¿‡å†…è”è„šæœ¬æˆ–dataå±æ€§ï¼‰
			const menuData = document.querySelector("[data-menu-tree]");
			if (menuData && menuData.textContent) {
				try {
					this.menuTree = JSON.parse(menuData.textContent);
					console.log("ğŸ“‹ èœå•æ•°æ®åŠ è½½æˆåŠŸ:", this.menuTree);
				} catch (e) {
					console.warn("âš ï¸ æ— æ³•è§£æèœå•æ•°æ®:", e);
				}
			} else {
				console.warn("âš ï¸ æœªæ‰¾åˆ°èœå•æ•°æ®å…ƒç´ ");
			}
		}

		setupRouteListener() {
			// ç›‘å¬ popstate äº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›åé€€ï¼‰
			window.addEventListener("popstate", () => {
				this.updateCurrentPath(window.location.pathname);
			});

			// ç›‘å¬é¡µé¢è·¯ç”±å˜åŒ–ï¼ˆè‡ªå®šä¹‰äº‹ä»¶ï¼‰
			window.addEventListener("route-change", (e: Event) => {
				const customEvent = e as CustomEvent;
				if (customEvent.detail && customEvent.detail.path) {
					this.updateCurrentPath(customEvent.detail.path);
				}
			});
		}

		updateCurrentPath(newPath: string) {
			if (this.currentPath === newPath) return;

			console.log("ğŸ”„ è·¯å¾„æ›´æ–°:", this.currentPath, "->", newPath);
			this.currentPath = newPath;
			this.updateSidebar();
		}

		updateSidebar() {
			this.updateMainMenu();
			this.updateSubMenu();
		}

		updateMainMenu() {
			const mainMenuItems = document.querySelectorAll(".main-menu-item");

			mainMenuItems.forEach((item) => {
				const itemPath = item.getAttribute("data-path");
				if (itemPath && this.currentPath.startsWith(itemPath)) {
					item.classList.add("active");
				} else {
					item.classList.remove("active");
				}
			});
		}

		updateSubMenu() {
			if (!this.menuTree || !Array.isArray(this.menuTree)) {
				console.warn("âš ï¸ èœå•æ•°æ®ä¸å¯ç”¨");
				return;
			}

			// æ‰¾åˆ°å½“å‰æ¿€æ´»çš„ä¸»èœå•
			const currentMainMenu = this.menuTree.find((item: MenuTreeItem) =>
				this.currentPath.startsWith(item.path)
			);

			const sidebarContent = document.querySelector(".sidebar-content");
			if (!sidebarContent) {
				console.warn("âš ï¸ æœªæ‰¾åˆ°ä¾§è¾¹æ å†…å®¹å®¹å™¨");
				return;
			}

			const existingSubMenu = sidebarContent.querySelector(".submenu-section");

			if (
				currentMainMenu &&
				currentMainMenu.children &&
				currentMainMenu.children.length > 0
			) {
				// ç”Ÿæˆæ–°çš„å­èœå•HTML
				const subMenuHTML = this.generateSubMenuHTML(currentMainMenu);

				if (existingSubMenu) {
					existingSubMenu.outerHTML = subMenuHTML;
				} else {
					sidebarContent.insertAdjacentHTML("beforeend", subMenuHTML);
				}

				// é‡æ–°ç»‘å®šäº‹ä»¶
				this.bindSubMenuEvents();
			} else {
				// ç§»é™¤å­èœå•
				if (existingSubMenu) {
					existingSubMenu.remove();
				}
			}
		}

		generateSubMenuHTML(currentMainMenu: MenuTreeItem) {
			const isMainMenuAccess = this.currentPath === currentMainMenu.path;

			// æ£€æŸ¥å½“å‰ä¸»èœå•æ˜¯å¦æœ‰ä»»ä½•åŒ…å«äºŒçº§é¡µé¢çš„é¡¹ç›®
			const hasAnySubMenu = currentMainMenu.children!.some(
				(item) => item.children && item.children.length > 0
			);

			let html = `<div class='submenu-section'><div class='submenu-content'>`;

			currentMainMenu.children!.forEach((subItem: MenuTreeItem) => {
				const isActive =
					this.currentPath === subItem.path ||
					this.currentPath.startsWith(subItem.path + "/");
				const hasChildren = subItem.children && subItem.children.length > 0;
				const shouldExpand = isActive || isMainMenuAccess;

				html += `<div class='submenu-group'>`;
				html += `<a href="${this.escapeHtml(subItem.path)}" data-astro-prefetch class="submenu-group-header ${isActive ? "active" : ""}">`;

				if (hasChildren) {
					html += `<span class="submenu-expand-arrow ${shouldExpand ? "expanded" : ""}">
						<svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
							<path d='m9 18 6-6-6-6' />
						</svg>
					</span>`;
				} else if (hasAnySubMenu) {
					html += `<span class='submenu-expand-arrow submenu-expand-placeholder'></span>`;
				}

				html += `<span class='submenu-group-title'>${this.escapeHtml(subItem.label)}</span></a>`;

				if (hasChildren && shouldExpand && subItem.children) {
					html += `<div class='submenu-children'>`;
					subItem.children.forEach((childItem: MenuTreeItem) => {
						const childActive = this.currentPath === childItem.path;
						html += `
							<div class='submenu-item'>
								<a href="${this.escapeHtml(childItem.path)}" data-astro-prefetch class="submenu-item-link ${childActive ? "active" : ""}">
									<div class="submenu-indicator ${childActive ? "active" : ""}"></div>
									<span class='submenu-item-text'>${this.escapeHtml(childItem.label)}</span>
								</a>
							</div>`;
					});
					html += `</div>`;
				}

				html += `</div>`;
			});

			html += `</div></div>`;
			return html;
		}

		bindMenuEvents() {
			this.bindSubMenuEvents();
		}

		bindSubMenuEvents() {
			const submenuGroups = document.querySelectorAll(".submenu-group");

			submenuGroups.forEach((group) => {
				const expandArrow = group.querySelector(
					".submenu-expand-arrow:not(.submenu-expand-placeholder)"
				) as HTMLElement;
				const childrenContainer = group.querySelector(
					".submenu-children"
				) as HTMLElement;

				if (expandArrow && childrenContainer) {
					// ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
					const newExpandArrow = expandArrow.cloneNode(true) as HTMLElement;
					if (expandArrow.parentNode) {
						expandArrow.parentNode.replaceChild(newExpandArrow, expandArrow);
					}

					newExpandArrow.addEventListener("click", (e) => {
						e.preventDefault();
						e.stopPropagation();
						this.toggleSubmenuExpansion(newExpandArrow, childrenContainer);
					});
				}
			});
		}

		toggleSubmenuExpansion(
			expandArrow: HTMLElement,
			childrenContainer: HTMLElement
		) {
			const isExpanded = expandArrow.classList.contains("expanded");

			if (isExpanded) {
				expandArrow.classList.remove("expanded");
				childrenContainer.style.display = "none";
			} else {
				expandArrow.classList.add("expanded");
				childrenContainer.style.display = "block";
			}
		}

		escapeHtml(text: string) {
			const div = document.createElement("div");
			div.textContent = text || "";
			return div.innerHTML;
		}

		// å…¬å…±æ–¹æ³•ï¼šä¾›å¤–éƒ¨è°ƒç”¨
		static getInstance() {
			if (!window.sidebarManager) {
				window.sidebarManager = new SidebarManager();
			}
			return window.sidebarManager;
		}

		static updatePath(newPath: string) {
			const instance = SidebarManager.getInstance();
			instance.updateCurrentPath(newPath);
		}
	}

	// åˆå§‹åŒ–ä¾§è¾¹æ ç®¡ç†å™¨
	document.addEventListener("DOMContentLoaded", () => {
		try {
			SidebarManager.getInstance();
			console.log("âœ… ä¾§è¾¹æ ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ");
		} catch (error) {
			console.error("âŒ ä¾§è¾¹æ ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:", error);
		}
	});

	// å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾›å®¢æˆ·ç«¯è·¯ç”±ä½¿ç”¨
	window.SidebarManager = SidebarManager;
</script>
