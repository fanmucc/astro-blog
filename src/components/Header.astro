---
// src/components/Header.astro - 修复后的头部导航组件
export interface Props {
	currentPath?: string;
	showSearch?: boolean;
	showThemeToggle?: boolean;
}

const {
	currentPath = Astro.url.pathname,
	showSearch = false,
	showThemeToggle = true,
} = Astro.props;
---

<header class='header-nav'>
	<div class='header-container'>
		<div class='header-content'>
			<!-- 左侧：Logo -->
			<div class='logo-section'>
				<a href='/' class='logo-link' data-astro-prefetch>
					<div class='logo-icon'>
						<svg viewBox='0 0 120 120' class='h-10 w-10'>
							<defs>
								<linearGradient
									id='primaryGradient'
									x1='0%'
									y1='0%'
									x2='100%'
									y2='100%'
								>
									<stop offset='0%' style='stop-color:#f59e0b;stop-opacity:1'></stop>
									<stop offset='100%' style='stop-color:#d97706;stop-opacity:1'></stop>
								</linearGradient>
								<filter
									id='shadow'
									x='-20%'
									y='-20%'
									width='140%'
									height='140%'
								>
									<feDropShadow
										dx='1'
										dy='2'
										stdDeviation='2'
										flood-opacity='0.2'
										flood-color='#000'></feDropShadow>
								</filter>
							</defs>
							<circle
								cx='60'
								cy='60'
								r='56'
								fill='url(#primaryGradient)'
								filter='url(#shadow)'></circle>
							<g transform='translate(60, 60)'>
								<path
									d='M -20 -15 Q -25 -15 -25 -10 L -25 -5 Q -25 0 -30 0 Q -25 0 -25 5 L -25 10 Q -25 15 -20 15'
									stroke='white'
									stroke-width='3'
									fill='none'
									stroke-linecap='round'></path>
								<path
									d='M 20 -15 Q 25 -15 25 -10 L 25 -5 Q 25 0 30 0 Q 25 0 25 5 L 25 10 Q 25 15 20 15'
									stroke='white'
									stroke-width='3'
									fill='none'
									stroke-linecap='round'></path>
								<circle cx='-8' cy='-3' r='2' fill='white'></circle>
								<circle cx='0' cy='3' r='2' fill='white'></circle>
								<circle cx='8' cy='-3' r='2' fill='white'></circle>
							</g>
							<g opacity='0.3'>
								<polygon points='15,25 25,15 35,25' fill='white'></polygon>
								<polygon points='85,85 95,90 85,95 75,90' fill='white'></polygon>
							</g>
						</svg>
					</div>
					<div class='logo-text'>
						<span class='logo-title'>Fanmu</span>
						<span class='logo-subtitle'>yancode.life</span>
					</div>
				</a>
			</div>

			<!-- 右侧：搜索 + 主题切换 + 快捷链接 -->
			<div class='header-actions'>
				<!-- 快捷外部链接 -->
				<div class='external-links'>
					<button
						onclick="window.open('/github', '_blank')"
						class='action-btn'
						title='GitHub'
						aria-label='GitHub'
					>
						<svg class='h-5 w-5' fill='currentColor' viewBox='0 0 24 24'>
							<path
								d='M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z'
							></path>
						</svg>
					</button>
				</div>

				<!-- 搜索框 -->
				{
					false && (
						<div class='search-container'>
							<div class='search-wrapper'>
								<input
									type='search'
									placeholder='搜索'
									id='global-search'
									class='search-input'
								/>
								<div class='search-icon-wrapper'>
									<svg
										class='search-icon'
										fill='none'
										stroke='currentColor'
										viewBox='0 0 24 24'
									>
										<path
											stroke-linecap='round'
											stroke-linejoin='round'
											stroke-width='2'
											d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
										/>
									</svg>
								</div>
								<div class='search-kbd-wrapper'>
									<kbd class='search-kbd'>
										<span class='text-xs'>⌘</span>K
									</kbd>
								</div>
							</div>
						</div>
					)
				}

				<!-- 主题切换按钮 -->
				{
					showThemeToggle && (
						<button
							id='theme-toggle'
							class='action-btn theme-toggle'
							aria-label='切换主题'
							title='切换主题'
						>
							<!-- 太阳图标 (浅色模式时显示) -->
							<svg
								class='theme-icon theme-icon-sun'
								fill='none'
								stroke='currentColor'
								viewBox='0 0 24 24'
								stroke-width='2'
							>
								<circle cx='12' cy='12' r='5'></circle>
								<path d='M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42'></path>
							</svg>
							
							<!-- 月亮图标 (深色模式时显示) -->
							<svg
								class='theme-icon theme-icon-moon'
								fill='none'
								stroke='currentColor'
								viewBox='0 0 24 24'
								stroke-width='2'
							>
								<path d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'></path>
							</svg>
						</button>
					)
				}
			</div>
		</div>
	</div>
</header>

<!-- 主题切换脚本 -->
<script>
	// 主题切换功能 - 高性能帧同步版
	function initThemeToggle() {
		const themeToggle = document.getElementById('theme-toggle');
		
		if (!themeToggle) return;

		let isTransitioning = false;
		let animationId: number | null = null;
		
		// 性能检测 - 根据设备性能选择动画策略
		const isHighPerformance = (() => {
			// 检查是否支持 requestAnimationFrame
			if (!window.requestAnimationFrame) return false;
			
			// 检查是否偏好减少动画
			if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return false;
			
			// 检查设备内存（如果可用）
			const nav = navigator as any;
			if (nav.deviceMemory && nav.deviceMemory < 4) return false;
			
			// 检查硬件并发（CPU 核心数）
			if (nav.hardwareConcurrency && nav.hardwareConcurrency < 4) return false;
			
			return true;
		})();

		// 输出性能检测结果
		console.log(`🎨 主题切换性能模式: ${isHighPerformance ? '高性能动画' : '简化模式'}`);

		// 简化版主题切换（适用于低性能设备）
		function toggleThemeSimple() {
			const html = document.documentElement;
			const isDark = html.classList.contains('dark');

			html.classList.add('theme-transitioning');

			// 直接切换主题，无动画
			if (isDark) {
				html.classList.remove('dark');
				localStorage.setItem('theme', 'light');
				console.log('🌞 切换到浅色模式（简化版）');
			} else {
				html.classList.add('dark');
				localStorage.setItem('theme', 'dark');
				console.log('🌙 切换到深色模式（简化版）');
			}

			// 快速清理
			requestAnimationFrame(() => {
				html.classList.remove('theme-transitioning');
				isTransitioning = false;
			});
		}

		// 创建流畅的圆形扩散动画 - 基于 requestAnimationFrame
		function createRippleEffect(button: HTMLElement): Promise<HTMLElement> {
			return new Promise((resolve) => {
				const rect = button.getBoundingClientRect();
				// 计算需要覆盖整个屏幕的圆形大小
				const maxDistance = Math.sqrt(
					Math.pow(window.innerWidth, 2) + Math.pow(window.innerHeight, 2)
				) * 1.1; // 增加 10% 确保完全覆盖
				
				// 移除已存在的动画元素
				const existingRipple = document.querySelector('.theme-ripple');
				if (existingRipple) {
					existingRipple.remove();
				}

				// 创建圆形动画元素
				const ripple = document.createElement('div');
				ripple.className = 'theme-ripple';
				ripple.style.cssText = `
					position: fixed;
					top: ${rect.top + rect.height / 2}px;
					left: ${rect.left + rect.width / 2}px;
					width: ${maxDistance}px;
					height: ${maxDistance}px;
					border-radius: 50%;
					background: var(--theme-ripple-bg);
					pointer-events: none;
					z-index: 10000;
					transform: translate(-50%, -50%) scale(0);
					opacity: 0.9;
					will-change: transform, opacity;
					contain: layout style paint;
				`;

				document.body.appendChild(ripple);

				// 使用 requestAnimationFrame 进行帧同步动画
				let startTime: number | null = null;
				const duration = 600; // 600ms 总动画时长
				const switchPoint = 0.3; // 30% 时切换主题

				function animate(currentTime: number) {
					if (!startTime) startTime = currentTime;
					const elapsed = currentTime - startTime;
					const progress = Math.min(elapsed / duration, 1);

					// 使用更流畅的缓动函数（ease-out-expo）
					const easedProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
					
					// 设置变换
					ripple.style.transform = `translate(-50%, -50%) scale(${easedProgress})`;
					ripple.style.opacity = `${0.9 - (progress * 0.7)}`; // 从 0.9 到 0.2

					// 在 30% 进度时触发主题切换
					if (progress >= switchPoint && !ripple.dataset.switched) {
						ripple.dataset.switched = 'true';
						resolve(ripple);
					}

					// 继续动画直到完成
					if (progress < 1) {
						animationId = requestAnimationFrame(animate);
					} else {
						// 动画完成
						if (!ripple.dataset.switched) {
							resolve(ripple);
						}
					}
				}

				animationId = requestAnimationFrame(animate);
			});
		}

		async function toggleTheme() {
			// 防止重复点击
			if (isTransitioning) return;
			isTransitioning = true;

			// 根据性能选择动画策略
			if (!isHighPerformance) {
				toggleThemeSimple();
				return;
			}

			// 取消之前的动画
			if (animationId) {
				cancelAnimationFrame(animationId);
				animationId = null;
			}

			const html = document.documentElement;
			const isDark = html.classList.contains('dark');

			// 设置扇形动画的背景色
			if (isDark) {
				html.style.setProperty('--theme-ripple-bg', '#ffffff');
			} else {
				html.style.setProperty('--theme-ripple-bg', '#0f172a');
			}

			// 添加过渡类
			html.classList.add('theme-transitioning');

			try {
				// 创建扇形动画并等待切换点
				const ripple = await createRippleEffect(themeToggle!);

				// 使用 requestAnimationFrame 确保在下一帧执行主题切换
				requestAnimationFrame(() => {
					// 切换主题
					if (isDark) {
						html.classList.remove('dark');
						localStorage.setItem('theme', 'light');
						console.log('🌞 切换到浅色模式');
					} else {
						html.classList.add('dark');
						localStorage.setItem('theme', 'dark');
						console.log('🌙 切换到深色模式');
					}
				});

				// 等待动画完全结束后清理
				requestAnimationFrame(() => {
					setTimeout(() => {
						html.classList.remove('theme-transitioning');
						if (ripple && ripple.parentNode) {
							ripple.remove();
						}
						isTransitioning = false;
					}, 300); // 给主题变量切换留出时间
				});

			} catch (error) {
				console.error('主题切换动画出错:', error);
				// 失败时直接切换主题
				if (isDark) {
					html.classList.remove('dark');
					localStorage.setItem('theme', 'light');
				} else {
					html.classList.add('dark');
					localStorage.setItem('theme', 'dark');
				}
				html.classList.remove('theme-transitioning');
				isTransitioning = false;
			}
		}

		// 绑定点击事件
		themeToggle.addEventListener('click', () => toggleTheme());
	}

	// 页面加载时初始化
	document.addEventListener('DOMContentLoaded', initThemeToggle);
	
	// 支持 Astro View Transitions
	document.addEventListener('astro:after-swap', initThemeToggle);
</script>

<style>
	/* 头部导航样式 */
	.header-nav {
		position: sticky;
		top: 0;
		z-index: 50;
		width: 100%;
		border-bottom: 1px solid var(--h-nav-border);
		background-color: var(--h-nav-bg);
		backdrop-filter: blur(12px);
		transition: all var(--transition-fast);
	}

	.header-container {
		max-width: 100%;
		margin: 0 auto;
		padding: 0 1rem;
	}

	@media (min-width: 640px) {
		.header-container {
			padding: 0 1.5rem;
		}
	}

	@media (min-width: 1024px) {
		.header-container {
			padding: 0 2rem;
		}
	}

	.header-content {
		display: flex;
		align-items: center;
		justify-content: space-between;
		height: 4rem;
	}

	/* Logo 区域 */
	.logo-section {
		display: flex;
		align-items: center;
	}

	.logo-link {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		text-decoration: none;
		transition: all var(--transition-fast);
	}

	.logo-link:hover {
		transform: translateY(-1px);
	}

	.logo-icon {
		display: flex;
		height: 2.5rem;
		width: 2.5rem;
		align-items: center;
		justify-content: center;
		border-radius: 0.5rem;
		box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
		transition: all var(--transition-fast);
	}

	.logo-link:hover .logo-icon {
		box-shadow:
			0 4px 6px -1px rgb(0 0 0 / 0.1),
			0 2px 4px -2px rgb(0 0 0 / 0.1);
	}

	.logo-text {
		display: flex;
		flex-direction: column;
	}

	.logo-title {
		font-size: 1.25rem;
		font-weight: 700;
		color: var(--h-nav-text);
		transition: color var(--transition-fast);
		line-height: 1.2;
	}

	.logo-link:hover .logo-title {
		color: var(--h-nav-text-hover);
	}

	.logo-subtitle {
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--g-text-tertiary);
		line-height: 1;
	}

	/* 右侧操作区域 */
	.header-actions {
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.external-links {
		display: none;
	}

	@media (min-width: 768px) {
		.external-links {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
	}

	.action-btn {
		padding: 0.5rem;
		border-radius: 0.5rem;
		transition: all var(--transition-fast);
		color: var(--g-text-secondary);
		background-color: transparent;
		border: none;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
	}

	.action-btn:hover {
		color: var(--h-nav-text-hover);
		background-color: var(--a-main-item-bg-hover);
		transform: translateY(-1px);
	}

	.action-btn:focus {
		outline: none;
	}

	/* 搜索框 */
	.search-container {
		position: relative;
	}

	.search-wrapper {
		position: relative;
	}

	.search-input {
		width: 16rem;
		padding: 0.625rem 1rem 0.625rem 2.5rem;
		font-size: 0.875rem;
		background-color: var(--s-input-bg);
		border: 1px solid var(--s-input-border);
		color: var(--s-input-text);
		border-radius: 0.5rem;
		transition: all var(--transition-fast);
	}

	.search-input:focus {
		outline: none;
		border-color: var(--s-input-border-focus);
		box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
	}

	.search-input::placeholder {
		color: var(--s-input-placeholder);
	}

	.search-icon-wrapper {
		position: absolute;
		top: 0;
		left: 0;
		height: 100%;
		width: 2.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		pointer-events: none;
	}

	.search-icon {
		height: 1rem;
		width: 1rem;
		color: var(--s-input-placeholder);
	}

	.search-kbd-wrapper {
		position: absolute;
		top: 0;
		right: 0;
		height: 100%;
		padding-right: 0.75rem;
		display: flex;
		align-items: center;
	}

	.search-kbd {
		height: 1.25rem;
		display: none;
		align-items: center;
		gap: 0.25rem;
		border-radius: 0.25rem;
		border: 1px solid var(--g-border);
		background-color: var(--g-bg-tertiary);
		padding: 0 0.375rem;
		font-family: monospace;
		font-size: 0.75rem;
		color: var(--g-text-tertiary);
	}

	@media (min-width: 640px) {
		.search-kbd {
			display: inline-flex;
		}
	}

	/* 主题切换按钮 */
	.theme-toggle {
		position: relative;
	}

	.theme-icon {
		height: 1.25rem;
		width: 1.25rem;
		transition: all var(--transition-fast);
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
	}

	/* 浅色模式时显示太阳，隐藏月亮 */
	.theme-icon-sun {
		opacity: 1;
		transform: translate(-50%, -50%) rotate(0deg) scale(1);
	}

	.theme-icon-moon {
		opacity: 0;
		transform: translate(-50%, -50%) rotate(90deg) scale(0);
	}

	/* 深色模式时显示月亮，隐藏太阳 */
	.dark .theme-icon-sun {
		opacity: 0;
		transform: translate(-50%, -50%) rotate(-90deg) scale(0);
	}

	.dark .theme-icon-moon {
		opacity: 1;
		transform: translate(-50%, -50%) rotate(0deg) scale(1);
	}

	/* 响应式设计 */
	@media (max-width: 640px) {
		.search-input {
			width: 12rem;
		}

		.header-actions {
			gap: 0.5rem;
		}
	}

	@media (min-width: 768px) and (max-width: 1024px) {
		.search-input {
			width: 14rem;
		}
	}

	@media (min-width: 1280px) {
		.search-input {
			width: 18rem;
		}
	}
</style>