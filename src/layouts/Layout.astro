---
// src/layouts/Layout.astro - ä¸»è¦é¡µé¢å¸ƒå±€ç»„ä»¶
import { ViewTransitions } from 'astro:transitions';
import Header from '../components/Header.astro';
import Sidebar from '../components/Sidebar.astro';
import { buildMenuTree } from '../utils/menu';

export interface Props {
	// åŸºç¡€é¡µé¢å±æ€§
	title: string;
	description?: string;
	image?: string;
	canonical?: string;
	noindex?: boolean;
	
	// å¸ƒå±€æ§åˆ¶
	currentPath?: string;
	showSidebar?: boolean;
	showHeader?: boolean;
	showBreadcrumb?: boolean;
	
	// ä¸»é¢˜æ§åˆ¶
	theme?: 'light' | 'dark' | 'auto';
	
	// é¡µé¢ç±»å‹
	pageType?: 'home' | 'article' | 'index' | 'search';
}

const {
	title,
	description = "åˆ†äº«æŠ€æœ¯è§è§£ã€ç”Ÿæ´»æ„Ÿæ‚Ÿå’Œå­¦ä¹ å¿ƒå¾—",
	image = "/og-image.jpg",
	canonical,
	noindex = false,
	currentPath = Astro.url.pathname,
	showSidebar = true,
	showHeader = true,
	showBreadcrumb = false,
	theme = 'auto',
	pageType = 'article'
} = Astro.props;

// è·å–å½“å‰ URL
const canonicalURL = canonical || new URL(Astro.url.pathname, Astro.site);
const socialImage = new URL(image, Astro.site);

// æ„å»ºèœå•æ ‘ï¼ˆå¦‚æœéœ€è¦sidebarï¼‰
const menuTree = showSidebar ? await buildMenuTree() : [];
---

<!doctype html>
<html lang='zh-CN' class='scroll-smooth'>
	<head>
		<meta charset='UTF-8' />
		<meta name='description' content={description} />
		<meta name='viewport' content='width=device-width, initial-scale=1.0' />
		<link rel='icon' type='image/svg+xml' href='/favicon.svg' />
		<meta name='generator' content={Astro.generator} />

		<!-- é¡µé¢æ ‡é¢˜ -->
		<title>{title} - Fanmu</title>

		<!-- è§„èŒƒé“¾æ¥ -->
		<link rel='canonical' href={canonicalURL} />

		<!-- æœç´¢å¼•æ“ä¼˜åŒ– -->
		{noindex && <meta name='robots' content='noindex, nofollow' />}

		<!-- Open Graph / Facebook -->
		<meta property='og:type' content='website' />
		<meta property='og:url' content={canonicalURL} />
		<meta property='og:title' content={`${title} - Fanmu`} />
		<meta property='og:description' content={description} />
		<meta property='og:image' content={socialImage} />
		<meta property='og:site_name' content='Fanmu - yancode.life' />
		<meta property='og:locale' content='zh_CN' />

		<!-- Twitter -->
		<meta property='twitter:card' content='summary_large_image' />
		<meta property='twitter:url' content={canonicalURL} />
		<meta property='twitter:title' content={`${title} - Fanmu`} />
		<meta property='twitter:description' content={description} />
		<meta property='twitter:image' content={socialImage} />

		<!-- é¢å¤–çš„ meta æ ‡ç­¾ -->
		<meta name='author' content='Fanmu' />
		<meta name='theme-color' content='#f97316' />

		<!-- å­—ä½“å’Œé¢„è¿æ¥ -->
		<link rel='preconnect' href='https://fonts.googleapis.com' />
		<link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />
		<link
			href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap'
			rel='stylesheet'
		/>
		<link
			href='https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap'
			rel='stylesheet'
		/>

		<!-- å¯ç”¨ View Transitions ä»¥è·å¾—å¹³æ»‘çš„é¡µé¢åˆ‡æ¢ä½“éªŒ -->
		<ViewTransitions />

		<!-- ä¸»é¢˜åˆå§‹åŒ–è„šæœ¬ -->
		<script is:inline define:vars={{ theme }}>
			(function initTheme() {
				console.log("ğŸ¨ åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿ...");

				const savedTheme = localStorage.getItem("theme");
				const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
				const propTheme = theme;

				let finalTheme;
				if (savedTheme) {
					finalTheme = savedTheme;
				} else if (propTheme && propTheme !== 'auto') {
					finalTheme = propTheme;
				} else if (prefersDark) {
					finalTheme = "dark";
				} else {
					finalTheme = "light";
				}

				if (finalTheme === "dark") {
					document.documentElement.classList.add("dark");
				} else {
					document.documentElement.classList.remove("dark");
				}

				localStorage.setItem("theme", finalTheme);
				console.log("âœ… ä¸»é¢˜åˆå§‹åŒ–å®Œæˆ:", finalTheme);
			})();
		</script>
	</head>

	<body class='min-h-screen transition-all duration-300'>
		<div class='app-layout' data-page-type={pageType}>
			<!-- é¡¶éƒ¨å¯¼èˆª -->
			{showHeader && (
				<Header 
					currentPath={currentPath} 
					showSearch={true} 
					showThemeToggle={true} 
				/>
			)}

			<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
			<div class={`main-layout ${!showHeader ? 'no-header' : ''}`}>
				<!-- å·¦ä¾§è¾¹æ  -->
				{showSidebar && (
					<Sidebar 
						menuTree={menuTree} 
						currentPath={currentPath} 
					/>
				)}

				<!-- ä¸»å†…å®¹åŒº -->
				<main class={`main-content ${!showSidebar ? 'full-width' : ''}`}>
					<div class='content-container'>
						<!-- é¢åŒ…å±‘å¯¼èˆª -->
						{showBreadcrumb && (
							<nav class='breadcrumb-nav' id='breadcrumb-nav'>
								<!-- é¢åŒ…å±‘å°†é€šè¿‡è„šæœ¬ç”Ÿæˆ -->
							</nav>
						)}

		<!-- é¡µé¢å†…å®¹ -->
						<div class='content-area'>
		<slot />
						</div>
					</div>
				</main>
			</div>
		</div>

		<!-- é¡¶éƒ¨åŠ è½½è¿›åº¦æ¡ -->
		<div class='page-loader' id='page-loader'>
			<div class='page-loader-bar' id='page-loader-bar'></div>
		</div>

		<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
		<button
			id='back-to-top'
			class='fixed bottom-6 right-6 w-12 h-12 btn-primary rounded-full shadow-lg transition-all duration-300 transform translate-y-20 opacity-0 z-50'
			aria-label='è¿”å›é¡¶éƒ¨'
		>
			<svg class='w-6 h-6 mx-auto' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 10l7-7m0 0l7 7m-7-7v18'></path>
			</svg>
		</button>

		<!-- å…¨å±€è„šæœ¬ -->
		<script define:vars={{ menuTree, currentPath, showBreadcrumb }}>
			// åŠ¨æ€è°ƒæ•´ä¾§è¾¹æ ä½ç½®ï¼ˆé’ˆå¯¹å›ºå®šå®šä½ï¼‰
			function adjustSidebarPosition() {
				const header = document.querySelector('header');
				const sidebar = document.querySelector('.sidebar');
				const mainLayout = document.querySelector('.main-layout');
				
				if (sidebar) {
					let headerHeight = 0;
					
					if (header && header.offsetHeight > 0 && !mainLayout?.classList.contains('no-header')) {
						headerHeight = header.offsetHeight;
					}
					
					sidebar.style.top = headerHeight + 'px';
					sidebar.style.height = `calc(100vh - ${headerHeight}px)`;
					
					console.log("ğŸ”§ è°ƒæ•´å›ºå®šä¾§è¾¹æ ä½ç½®:", {
						headerHeight,
						top: headerHeight + 'px',
						height: `calc(100vh - ${headerHeight}px)`,
						hasHeader: !!header && !mainLayout?.classList.contains('no-header')
					});
				}
			}

			// å…¨å±€åŠŸèƒ½åˆå§‹åŒ–
			function initializeApp() {
			// è¿”å›é¡¶éƒ¨åŠŸèƒ½
				initBackToTop();
				
				// é¢åŒ…å±‘å¯¼èˆª
				if (showBreadcrumb) {
					generateBreadcrumb();
				}
				
				// å…¶ä»–å…¨å±€åŠŸèƒ½
				initGlobalFeatures();
			}

			// é¡µé¢é¦–æ¬¡åŠ è½½
			document.addEventListener("DOMContentLoaded", () => {
				initializeApp();
				// åŠ¨æ€è°ƒæ•´ä¾§è¾¹æ ä½ç½®
				setTimeout(() => {
					adjustSidebarPosition();
				}, 100);
			});
			
			// ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡è°ƒæ•´
			window.addEventListener("load", () => {
				setTimeout(() => {
					adjustSidebarPosition();
				}, 200);
			});
			
			// View Transitions é¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–
			document.addEventListener("astro:after-swap", () => {
				initializeApp();
				adjustSidebarPosition();
			});
			
			// çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
			window.addEventListener("resize", adjustSidebarPosition);
			
			// å¼€å‘è°ƒè¯•ï¼šæ·»åŠ å…¨å±€å‡½æ•°ä¾›æ§åˆ¶å°æµ‹è¯•
			window.testSidebarFixed = function() {
				const sidebar = document.querySelector('.sidebar');
				const sidebarContent = document.querySelector('.sidebar-content');
				
				if (sidebar) {
					const computedStyle = getComputedStyle(sidebar);
					console.log("ğŸ§ª æµ‹è¯•å›ºå®šä¾§è¾¹æ çŠ¶æ€:");
					console.log("ä½ç½®:", computedStyle.position);
					console.log("top:", computedStyle.top);
					console.log("left:", computedStyle.left);
					console.log("z-index:", computedStyle.zIndex);
					console.log("é«˜åº¦:", computedStyle.height);
					
					if (sidebarContent) {
						console.log("å†…å®¹æ»šåŠ¨:", {
							scrollTop: sidebarContent.scrollTop,
							scrollHeight: sidebarContent.scrollHeight,
							clientHeight: sidebarContent.clientHeight,
							canScroll: sidebarContent.scrollHeight > sidebarContent.clientHeight
						});
					}
				} else {
					console.log("âŒ æœªæ‰¾åˆ°ä¾§è¾¹æ ");
				}
			};
			
			// é¡µé¢åŠ è½½è¿›åº¦æ¡æ§åˆ¶
			let loadingTimer;
			let loadingProgress = 0;

			function showPageLoader() {
				const loader = document.getElementById("page-loader");
				const loaderBar = document.getElementById("page-loader-bar");
				
				if (loader && loaderBar) {
					// é‡ç½®è¿›åº¦
					loadingProgress = 0;
					loaderBar.style.width = "0%";
					
					// æ˜¾ç¤ºåŠ è½½æ¡
					loader.classList.add("loading");
					document.body.classList.add("page-transitioning");
					
					// æ¨¡æ‹ŸåŠ è½½è¿›åº¦
					loadingTimer = setInterval(() => {
						loadingProgress += Math.random() * 15 + 5; // æ¯æ¬¡å¢åŠ  5-20%
						
						if (loadingProgress > 90) {
							loadingProgress = 90; // åœ¨90%åœæ­¢ï¼Œç­‰å¾…å®é™…å®Œæˆ
						}
						
						loaderBar.style.width = loadingProgress + "%";
					}, 100);
				}
			}

			function hidePageLoader() {
				const loader = document.getElementById("page-loader");
				const loaderBar = document.getElementById("page-loader-bar");
				
				if (loader && loaderBar) {
					// æ¸…é™¤å®šæ—¶å™¨
					if (loadingTimer) {
						clearInterval(loadingTimer);
						loadingTimer = null;
					}
					
					// ç«‹å³å®Œæˆåˆ°100%
					loadingProgress = 100;
					loaderBar.style.width = "100%";
					
					// çŸ­æš‚å»¶è¿Ÿåéšè—
					setTimeout(() => {
						loader.classList.remove("loading");
						document.body.classList.remove("page-transitioning");
						
						// é‡ç½®è¿›åº¦æ¡
						setTimeout(() => {
							loaderBar.style.width = "0%";
						}, 200);
					}, 150);
				}
			}

			// é¡µé¢åˆ‡æ¢äº‹ä»¶ç›‘å¬ï¼ˆView Transitionsï¼‰
			document.addEventListener("astro:before-preparation", showPageLoader);
			document.addEventListener("astro:after-swap", hidePageLoader);

			// å®¢æˆ·ç«¯è·¯ç”±ç³»ç»Ÿ
			class ClientRouter {
				constructor() {
					this.isNavigating = false;
					this.setupEventListeners();
					this.saveCurrentState();
					
					// åˆå§‹åŒ–æ—¶è®¾ç½®æ­£ç¡®çš„èœå•çŠ¶æ€
					setTimeout(() => {
						this.updateSidebarMenus();
						// åˆå§‹åŒ–æ—¶ä¹Ÿç»‘å®šäº‹ä»¶
						this.bindSubmenuEvents();
					}, 100);
					
					// é¡µé¢åŠ è½½å®Œæˆåä¹Ÿæ›´æ–°ä¸€æ¬¡èœå•çŠ¶æ€
					if (document.readyState === 'loading') {
						document.addEventListener('DOMContentLoaded', () => {
							setTimeout(() => {
								this.updateSidebarMenus();
								this.bindSubmenuEvents();
							}, 50);
						});
					}
				}

				saveCurrentState() {
					// ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€åˆ°å†å²è®°å½•
					history.replaceState({ 
						url: window.location.href,
						title: document.title 
					}, document.title, window.location.href);
				}

				async navigate(url, addToHistory = true) {
					if (this.isNavigating || url === window.location.href) return;
					
					this.isNavigating = true;
					console.log("ğŸš€ å¼€å§‹å®¢æˆ·ç«¯è·¯ç”±è·³è½¬:", url);
					showPageLoader();

					try {
						// è·å–æ–°é¡µé¢å†…å®¹
						const response = await fetch(url);
						if (!response.ok) throw new Error(`HTTP ${response.status}`);
						
						const html = await response.text();
						const parser = new DOMParser();
						const newDoc = parser.parseFromString(html, 'text/html');

						// æ›´æ–°é¡µé¢å†…å®¹
						await this.updatePage(newDoc, url, addToHistory);
						
						console.log("âœ… å®¢æˆ·ç«¯è·¯ç”±è·³è½¬å®Œæˆ");
					} catch (error) {
						console.error("âŒ å®¢æˆ·ç«¯è·¯ç”±å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šè·³è½¬:", error);
						// å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨æ™®é€šé¡µé¢è·³è½¬
						window.location.href = url;
						return;
					} finally {
						this.isNavigating = false;
						hidePageLoader();
					}
				}

				async updatePage(newDoc, url, addToHistory) {
					// æ·»åŠ é¡µé¢åˆ‡æ¢è¿‡æ¸¡æ•ˆæœ
					const mainContent = document.querySelector('.main-content');
					const contentArea = document.querySelector('.content-area');
					
					if (contentArea) {
						contentArea.style.opacity = '0.7';
						contentArea.style.transform = 'translateY(10px)';
						contentArea.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
					}

					// çŸ­æš‚å»¶è¿Ÿåå¼€å§‹æ›´æ–°å†…å®¹
					await new Promise(resolve => setTimeout(resolve, 150));

					// æ›´æ–° URL å’Œæ ‡é¢˜
					if (addToHistory) {
						history.pushState({ 
							url: url,
							title: newDoc.title 
						}, newDoc.title, url);
					}
					document.title = newDoc.title;

					// æ›´æ–°ä¸»è¦å†…å®¹åŒºåŸŸ
					const currentMain = document.querySelector('main.main-content');
					const newMain = newDoc.querySelector('main.main-content');
					
					if (currentMain && newMain) {
						// æ›´æ–°å†…å®¹
						currentMain.innerHTML = newMain.innerHTML;
						
						// æ›´æ–°é¡µé¢ç±»å‹æ•°æ®å±æ€§
						const currentLayout = document.querySelector('.app-layout');
						const newLayout = newDoc.querySelector('.app-layout');
						if (currentLayout && newLayout) {
							const pageType = newLayout.getAttribute('data-page-type');
							if (pageType) {
								currentLayout.setAttribute('data-page-type', pageType);
							}
						}
					}

					// æ›´æ–° meta æ ‡ç­¾å’Œå¤´éƒ¨ä¿¡æ¯
					this.updateMetaTags(newDoc);

					// é‡æ–°åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
					await this.reinitializePage();

					// æ¢å¤å†…å®¹æ˜¾ç¤ºæ•ˆæœ
					const updatedContentArea = document.querySelector('.content-area');
					if (updatedContentArea) {
						updatedContentArea.style.opacity = '1';
						updatedContentArea.style.transform = 'translateY(0)';
						
						// æ¸…ç†è¿‡æ¸¡æ ·å¼
						setTimeout(() => {
							updatedContentArea.style.transition = '';
							updatedContentArea.style.transform = '';
						}, 300);
					}

					// æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}

				updateMetaTags(newDoc) {
					// æ›´æ–°éœ€è¦çš„ meta æ ‡ç­¾
					const metaSelectors = [
						'meta[name="description"]',
						'meta[property="og:title"]',
						'meta[property="og:description"]',
						'meta[property="og:url"]',
						'meta[name="twitter:title"]',
						'meta[name="twitter:description"]'
					];

					metaSelectors.forEach(selector => {
						const currentMeta = document.querySelector(selector);
						const newMeta = newDoc.querySelector(selector);
						
						if (currentMeta && newMeta) {
							const content = newMeta.getAttribute('content');
							if (content) {
								currentMeta.setAttribute('content', content);
							}
						} else if (!currentMeta && newMeta) {
							document.head.appendChild(newMeta.cloneNode(true));
						}
					});

					// æ›´æ–° canonical URL
					const currentCanonical = document.querySelector('link[rel="canonical"]');
					const newCanonical = newDoc.querySelector('link[rel="canonical"]');
					if (currentCanonical && newCanonical) {
						currentCanonical.setAttribute('href', newCanonical.getAttribute('href'));
					}
				}

				async reinitializePage() {
					console.log("ğŸ”„ é‡æ–°åˆå§‹åŒ–é¡µé¢åŠŸèƒ½");
					
					// é‡æ–°åˆå§‹åŒ–åº”ç”¨åŠŸèƒ½
					initBackToTop();
					if (showBreadcrumb) {
						generateBreadcrumb();
					}
					initGlobalFeatures();
					
					// æ›´æ–°ä¾§è¾¹æ èœå•çŠ¶æ€
					this.updateSidebarMenus();
					
					// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œè®©å…¶ä»–ç»„ä»¶çŸ¥é“é¡µé¢å·²æ›´æ–°
					window.dispatchEvent(new CustomEvent('clientRouteComplete', {
						detail: { url: window.location.href }
					}));

					// çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ
					await new Promise(resolve => setTimeout(resolve, 50));
				}

				updateSidebarMenus() {
					const currentPath = decodeURIComponent(window.location.pathname);
					console.log("ğŸ”„ æ›´æ–°ä¾§è¾¹æ èœå•çŠ¶æ€ï¼Œå½“å‰è·¯å¾„:", currentPath);
					console.log("ğŸ”„ åŸå§‹è·¯å¾„:", window.location.pathname);
					
					// æ›´æ–°ä¸»èœå•çŠ¶æ€
					this.updateMainMenu(currentPath);
					
					// æ›´æ–°å­èœå•çŠ¶æ€
					this.updateSubMenu(currentPath);
				}

				updateMainMenu(currentPath) {
					const mainMenuItems = document.querySelectorAll('.main-menu-item');
					let currentMainMenu = null;
					
					mainMenuItems.forEach(item => {
						const itemPath = item.getAttribute('data-path');
						const menuValue = item.getAttribute('data-menu');
						
						if (itemPath && currentPath.startsWith(itemPath)) {
							item.classList.add('active');
							currentMainMenu = {
								path: itemPath,
								value: menuValue
							};
						} else {
							item.classList.remove('active');
						}
					});
					
					return currentMainMenu;
				}

				updateSubMenu(currentPath) {
					// æ£€æŸ¥menuTreeæ˜¯å¦å¯ç”¨
					if (!menuTree || !Array.isArray(menuTree)) {
						console.warn("âš ï¸ menuTreeæ•°æ®ä¸å¯ç”¨ï¼Œè·³è¿‡å­èœå•æ›´æ–°");
						return;
					}

					// æ‰¾åˆ°å½“å‰æ¿€æ´»çš„ä¸»èœå•
					const activeMainMenu = document.querySelector('.main-menu-item.active');
					if (!activeMainMenu) {
						this.hideAllSubMenus();
						this.showEmptySubMenu();
						return;
					}

					const mainMenuValue = activeMainMenu.getAttribute('data-menu');
					const mainMenuPath = activeMainMenu.getAttribute('data-path');
					
					// æŸ¥æ‰¾å¯¹åº”çš„å­èœå•æ•°æ®
					const currentMainMenuData = menuTree.find(item => 
						item.value === mainMenuValue || item.path === mainMenuPath
					);
					
					if (!currentMainMenuData || !currentMainMenuData.children || currentMainMenuData.children.length === 0) {
						this.hideAllSubMenus();
						this.showEmptySubMenu();
						return;
					}

					// é‡æ–°æ¸²æŸ“å­èœå•
					this.renderSubMenu(currentMainMenuData, currentPath);

					// ç¡®ä¿å½“å‰è·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¤¹è‡ªåŠ¨å±•å¼€
					setTimeout(() => {
						this.ensureCorrectExpansion(currentPath);
					}, 50);
				}

				ensureCorrectExpansion(currentPath) {
					console.log("ğŸ” å¼€å§‹æ£€æŸ¥å±•å¼€çŠ¶æ€ï¼Œå½“å‰è·¯å¾„:", currentPath);
					
					// æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„ä¸»èœå•
					const activeMainMenu = document.querySelector('.main-menu-item.active');
					const mainMenuPath = activeMainMenu ? decodeURIComponent(activeMainMenu.getAttribute('data-path')) : null;
					
					// æ£€æŸ¥æ˜¯å¦é€šè¿‡ä¸€çº§ç›®å½•è¿›å…¥ï¼ˆè®¿é—®çš„æ˜¯ä¸»èœå•è·¯å¾„æˆ–å…¶ç›´æ¥å­è·¯å¾„ï¼‰
					const isMainMenuAccess = currentPath === mainMenuPath;
					
					console.log("ğŸ” è·¯å¾„åˆ†æ:", {
						currentPath,
						mainMenuPath,
						isMainMenuAccess
					});
					
					// æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶å¤¹é¡¹
					const folderItems = document.querySelectorAll('.submenu-folder-item');
					console.log("ğŸ” æ‰¾åˆ°æ–‡ä»¶å¤¹é¡¹æ•°é‡:", folderItems.length);
					
					folderItems.forEach((folderItem, index) => {
						const folderPath = folderItem.getAttribute('data-path');
						const expandArrow = folderItem.querySelector('.submenu-expand-arrow');
						const itemGroup = folderItem.closest('.submenu-item-group');
						const childrenContainer = itemGroup ? itemGroup.querySelector('.submenu-children') : null;
						
						console.log(`ğŸ” æ–‡ä»¶å¤¹ ${index + 1}:`, {
							folderPath,
							hasArrow: !!expandArrow,
							hasContainer: !!childrenContainer
						});
						
						if (folderPath && childrenContainer) {
							// è§£ç æ–‡ä»¶å¤¹è·¯å¾„ç”¨äºæ¯”è¾ƒ
							const decodedFolderPath = decodeURIComponent(folderPath);
							
							let shouldExpand = false;
							
							if (isMainMenuAccess) {
								// å¦‚æœæ˜¯é€šè¿‡ä¸€çº§ç›®å½•è¿›å…¥ï¼Œå±•å¼€æ‰€æœ‰å­èœå•
								shouldExpand = true;
								console.log("ğŸ” é€šè¿‡ä¸€çº§ç›®å½•è¿›å…¥ï¼Œå±•å¼€æ‰€æœ‰å­èœå•");
							} else {
								// å¦åˆ™åªå±•å¼€å½“å‰è·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¤¹
								shouldExpand = currentPath.startsWith(decodedFolderPath + '/') || 
											   currentPath === decodedFolderPath;
							}
							
							console.log(`ğŸ” æ–‡ä»¶å¤¹å±•å¼€æ£€æŸ¥:`, {
								folderPath: decodedFolderPath,
								currentPath,
								shouldExpand,
								reason: isMainMenuAccess ? 'ä¸€çº§ç›®å½•è¿›å…¥' : 'è·¯å¾„åŒ¹é…'
							});
							
							if (shouldExpand) {
								// å±•å¼€è¿™ä¸ªæ–‡ä»¶å¤¹
								folderItem.classList.add('expanded');
								if (expandArrow) {
									expandArrow.classList.add('expanded');
								}
								childrenContainer.style.display = 'block';
								
								console.log("âœ… è‡ªåŠ¨å±•å¼€æ–‡ä»¶å¤¹:", decodedFolderPath);
							} else {
								// æ”¶èµ·è¿™ä¸ªæ–‡ä»¶å¤¹ï¼ˆå¦‚æœå½“å‰è·¯å¾„ä¸åœ¨å…¶ä¸‹ï¼‰
								folderItem.classList.remove('expanded');
								if (expandArrow) {
									expandArrow.classList.remove('expanded');
								}
								childrenContainer.style.display = 'none';
								
								console.log("âŒ æ”¶èµ·æ–‡ä»¶å¤¹:", decodedFolderPath);
							}
						}
					});

					// æ‰‹åŠ¨è®¾ç½®äºŒçº§ç›®å½•å®¹å™¨çš„è¾¹æ¡†é¢œè‰²å’Œ active æŒ‡ç¤ºå™¨ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
					this.updateChildrenContainerBorders();
					this.updateActiveIndicators();
				}

				updateChildrenContainerBorders() {
					document.querySelectorAll('.submenu-children').forEach(container => {
						const hasActiveChild = container.querySelector('.submenu-child-link.active');
						if (hasActiveChild) {
							container.style.borderLeftColor = 'var(--a-submenu-children-border-left)';
						} else {
							container.style.borderLeftColor = '#e4e4e7';
						}
					});
				}

				updateActiveIndicators() {
					console.log("ğŸ¯ æ›´æ–° active æŒ‡ç¤ºå™¨");
					
					// ä¸ºæ¯ä¸ªå­èœå•å®¹å™¨åˆ›å»ºæˆ–æ›´æ–° active æŒ‡ç¤ºå™¨
					document.querySelectorAll('.submenu-children').forEach(container => {
						this.createActiveIndicator(container);
					});
				}

				createActiveIndicator(container) {
					// ç§»é™¤ç°æœ‰çš„æŒ‡ç¤ºå™¨
					const existingIndicator = container.querySelector('.submenu-active-indicator');
					if (existingIndicator) {
						existingIndicator.remove();
					}

					// æŸ¥æ‰¾ active çš„å­é“¾æ¥
					const activeLinks = container.querySelectorAll('.submenu-child-link.active');
					if (activeLinks.length === 0) return;

					// ä¸ºæ¯ä¸ª active é“¾æ¥åˆ›å»ºæŒ‡ç¤ºå™¨
					activeLinks.forEach(activeLink => {
						const allLinks = Array.from(container.querySelectorAll('.submenu-child-link'));
						const index = allLinks.indexOf(activeLink);
						
						if (index !== -1) {
							this.positionActiveIndicator(container, activeLink, index);
						}
					});
				}

				positionActiveIndicator(container, activeLink, index) {
					// åˆ›å»ºæŒ‡ç¤ºå™¨å…ƒç´ 
					const indicator = document.createElement('div');
					indicator.className = 'submenu-active-indicator';
					
					// è®¡ç®—ä½ç½®
					const linkHeight = activeLink.offsetHeight;
					const linkTop = activeLink.offsetTop;
					
					// è®¾ç½®æŒ‡ç¤ºå™¨çš„ä½ç½®å’Œå°ºå¯¸
					indicator.style.top = `${linkTop}px`;
					indicator.style.height = `${linkHeight}px`;
					
					console.log("ğŸ¯ åˆ›å»º active æŒ‡ç¤ºå™¨:", {
						index,
						linkHeight,
						linkTop,
						containerHeight: container.offsetHeight
					});
					
					// æ·»åŠ åˆ°å®¹å™¨ä¸­
					container.appendChild(indicator);
				}

				hideAllSubMenus() {
					const subMenuSections = document.querySelectorAll('.submenu-section');
					subMenuSections.forEach(section => {
						section.remove();
					});
				}

				showEmptySubMenu() {
					// å¦‚æœæ²¡æœ‰å­èœå•ï¼Œå°±ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Œä¿æŒç®€æ´
					const sidebar = document.querySelector('.sidebar-content');
					const existingSubMenu = sidebar.querySelector('.submenu-section');
					if (existingSubMenu) {
						existingSubMenu.remove();
					}
				}

				renderSubMenu(mainMenuData, currentPath) {
					const subMenuHtml = this.generateSubMenuHtml(mainMenuData, currentPath);
					
					const sidebar = document.querySelector('.sidebar-content');
					const existingSubMenu = sidebar.querySelector('.submenu-section');
					
					if (existingSubMenu) {
						existingSubMenu.outerHTML = subMenuHtml;
					} else {
						sidebar.insertAdjacentHTML('beforeend', subMenuHtml);
					}
					
					// é‡æ–°ç»‘å®šå±•å¼€æ”¶èµ·äº‹ä»¶
					this.bindSubmenuEvents();
					
					// æ›´æ–°äºŒçº§ç›®å½•å®¹å™¨è¾¹æ¡†é¢œè‰²å’Œ active æŒ‡ç¤ºå™¨
							setTimeout(() => {
						this.updateChildrenContainerBorders();
						this.updateActiveIndicators();
					}, 50);
				}

				bindSubmenuEvents() {
					console.log("ğŸ”— å¼€å§‹ç»‘å®šå­èœå•äº‹ä»¶");
					
					// ä¸ºæ–‡ä»¶å¤¹é¡¹ç»‘å®šå±•å¼€æ”¶èµ·äº‹ä»¶
					const itemGroups = document.querySelectorAll('.submenu-item-group');
					console.log("ğŸ”— æ‰¾åˆ°èœå•é¡¹ç»„æ•°é‡:", itemGroups.length);
					
					itemGroups.forEach((itemGroup, index) => {
						const folderItem = itemGroup.querySelector('.submenu-folder-item');
						if (!folderItem) {
							console.log(`ğŸ”— ç¬¬ ${index + 1} ä¸ªç»„æ²¡æœ‰æ–‡ä»¶å¤¹é¡¹`);
							return;
						}
						
						const folderWrapper = folderItem.querySelector('.submenu-folder-wrapper');
						const expandArrow = folderItem.querySelector('.submenu-expand-arrow');
						const folderLink = folderItem.querySelector('.submenu-folder-link');
						const childrenContainer = itemGroup.querySelector('.submenu-children');
						
						console.log(`ğŸ”— ç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹:`, {
							hasWrapper: !!folderWrapper,
							hasArrow: !!expandArrow,
							hasLink: !!folderLink,
							hasContainer: !!childrenContainer,
							folderPath: folderItem.getAttribute('data-path')
						});
						
						if (expandArrow && childrenContainer && folderWrapper) {
							// ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
							const newExpandArrow = expandArrow.cloneNode(true);
							expandArrow.parentNode.replaceChild(newExpandArrow, expandArrow);
							
							const newFolderWrapper = folderWrapper.cloneNode(true);
							folderWrapper.parentNode.replaceChild(newFolderWrapper, folderWrapper);
							
							// é‡æ–°è·å–å…ƒç´ å¼•ç”¨
							const currentExpandArrow = folderItem.querySelector('.submenu-expand-arrow');
							const currentFolderWrapper = folderItem.querySelector('.submenu-folder-wrapper');
							
							// ä¸ºç®­å¤´ç»‘å®šç‚¹å‡»äº‹ä»¶
							currentExpandArrow.addEventListener('click', (e) => {
								console.log("ğŸ”— ç®­å¤´è¢«ç‚¹å‡»");
								e.preventDefault();
								e.stopPropagation();
								
								this.toggleFolderExpansion(folderItem, currentExpandArrow, childrenContainer);
							});
							
							// ä¸ºæ–‡ä»¶å¤¹wrapperç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ•´ä¸ªåŒºåŸŸéƒ½å¯ä»¥ç‚¹å‡»ï¼‰
							currentFolderWrapper.addEventListener('click', (e) => {
								// å¦‚æœç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œåˆ™ä¸å¤„ç†å±•å¼€é€»è¾‘
								if (e.target.closest('.submenu-folder-link')) {
									console.log("ğŸ”— ç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œä¸å¤„ç†å±•å¼€");
									return;
								}
								
								console.log("ğŸ”— æ–‡ä»¶å¤¹åŒºåŸŸè¢«ç‚¹å‡»");
								e.preventDefault();
								e.stopPropagation();
								
								this.toggleFolderExpansion(folderItem, currentExpandArrow, childrenContainer);
							});
							
							console.log(`âœ… ç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹äº‹ä»¶ç»‘å®šå®Œæˆ`);
						} else {
							console.warn(`âš ï¸ ç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹ç¼ºå°‘å¿…è¦å…ƒç´ `);
						}
					});
				}

				toggleFolderExpansion(folderItem, expandArrow, childrenContainer) {
					const isExpanded = folderItem.classList.contains('expanded');
					const folderPath = folderItem.getAttribute('data-path');
					
					console.log("ğŸ”„ åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€:", {
						folderPath: decodeURIComponent(folderPath),
						currentlyExpanded: isExpanded,
						willExpand: !isExpanded
					});
					
					if (isExpanded) {
						folderItem.classList.remove('expanded');
						expandArrow.classList.remove('expanded');
						childrenContainer.style.display = 'none';
						console.log("ğŸ“ æ”¶èµ·æ–‡ä»¶å¤¹:", decodeURIComponent(folderPath));
					} else {
						folderItem.classList.add('expanded');
						expandArrow.classList.add('expanded');
						childrenContainer.style.display = 'block';
						console.log("ğŸ“‚ å±•å¼€æ–‡ä»¶å¤¹:", decodeURIComponent(folderPath));
					}
				}

				generateSubMenuHtml(mainMenuData, currentPath) {
					const escapeHtml = (text) => {
						const div = document.createElement('div');
						div.textContent = text;
						return div.innerHTML;
					};

					let html = `<div class='submenu-section'>`;

					mainMenuData.children.forEach(subItem => {
						const isCurrentPage = currentPath === subItem.path;
						const isParentActive = currentPath.startsWith(subItem.path + '/');
						const isActive = isCurrentPage || isParentActive;
						const hasChildren = subItem.children && subItem.children.length > 0;

						html += `<div class='submenu-item-group'>`;

						if (hasChildren) {
							// è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¸€çº§ç›®å½•ï¼‰ï¼Œéœ€è¦å±•å¼€æ”¶èµ·åŠŸèƒ½
							html += `
								<div class='submenu-folder-item ${isActive ? 'active expanded' : ''}' data-path="${escapeHtml(subItem.path)}">
									<div class="submenu-folder-wrapper">
										<span class="submenu-expand-arrow ${isActive ? 'expanded' : ''}">
											<svg width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
												<path d='m9 18 6-6-6-6' />
									</svg>
										</span>
										<a href="${escapeHtml(subItem.path)}" 
											 data-astro-prefetch 
											 class="submenu-folder-link">
											<span class='submenu-folder-text'>${escapeHtml(subItem.label)}</span>
										</a>
									</div>
								</div>`;

							// æ˜¾ç¤ºå­é¡¹å®¹å™¨ï¼ˆäºŒçº§ç›®å½•ï¼‰
							html += `<div class='submenu-children' style='display: ${isActive ? 'block' : 'none'}'>`;
							subItem.children.forEach(childItem => {
								const childActive = currentPath === childItem.path;
								html += `
									<a href="${escapeHtml(childItem.path)}" 
										 data-astro-prefetch 
										 class="submenu-child-link ${childActive ? 'active' : ''}">
										<span class='submenu-child-text'>${escapeHtml(childItem.label)}</span>
									</a>`;
							});
							html += `</div>`;

						} else {
							// è¿™æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ç« ï¼ˆä¸€çº§ç›®å½•æ–‡ç« ï¼‰
							html += `
								<a href="${escapeHtml(subItem.path)}" 
									 data-astro-prefetch 
									 class="submenu-article-link ${isActive ? 'active' : ''}">
									<div class="submenu-article-indicator ${isActive ? 'active' : ''}"></div>
									<span class='submenu-article-text'>${escapeHtml(subItem.label)}</span>
								</a>`;
						}

						html += `</div>`;
					});

					html += `</div>`;

					return html;
				}

				setupEventListeners() {
					// æ‹¦æˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
					document.addEventListener('click', (e) => {
						const link = e.target.closest('a');
						if (!link || !link.href) return;

						// æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨å®¢æˆ·ç«¯è·¯ç”±
						if (this.shouldUseClientRouting(link)) {
							e.preventDefault();
							console.log("ğŸ”— æ‹¦æˆªé“¾æ¥ç‚¹å‡»ï¼Œä½¿ç”¨å®¢æˆ·ç«¯è·¯ç”±:", link.href);
							this.navigate(link.href);
						}
					});

					// å¤„ç†æµè§ˆå™¨å‰è¿›åé€€
					window.addEventListener('popstate', (e) => {
						console.log("â¬…ï¸ æµè§ˆå™¨å‰è¿›åé€€äº‹ä»¶:", e.state);
						if (e.state && e.state.url) {
							this.navigate(e.state.url, false);
						} else {
							// å…œåº•å¤„ç†
							window.location.reload();
						}
					});

					// é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
					document.addEventListener('visibilitychange', () => {
						if (!document.hidden && this.isNavigating) {
							// é¡µé¢é‡æ–°å¯è§ä¸”æ­£åœ¨å¯¼èˆªä¸­ï¼Œç¡®ä¿éšè—åŠ è½½æ¡
							setTimeout(() => {
								if (this.isNavigating) {
									hidePageLoader();
									this.isNavigating = false;
								}
							}, 100);
						}
					});
				}

				shouldUseClientRouting(link) {
					const href = link.href;
					
					// åŸºæœ¬æ£€æŸ¥
					if (!href || href === '#') return false;
					
					// æ£€æŸ¥æ˜¯å¦ä¸ºç«™å†…é“¾æ¥
					const isInternalLink = href.startsWith(window.location.origin);
					if (!isInternalLink) return false;
					
					// æ’é™¤é”šç‚¹é“¾æ¥
					const isHashLink = href.includes('#') && 
						href.split('#')[0] === window.location.href.split('#')[0];
					if (isHashLink) return false;
					
					// æ’é™¤å¤–éƒ¨é“¾æ¥
					const isExternalLink = link.hasAttribute('target') && 
						link.getAttribute('target') === '_blank';
					if (isExternalLink) return false;
					
					// æ’é™¤ä¸‹è½½é“¾æ¥
					const hasDownload = link.hasAttribute('download');
					if (hasDownload) return false;
					
					// æ’é™¤ç‰¹æ®Šåè®®
					if (href.startsWith('mailto:') || href.startsWith('tel:')) return false;
					
					// æ’é™¤ API è·¯å¾„
					if (href.includes('/api/')) return false;
					
					console.log("âœ… é“¾æ¥ç¬¦åˆå®¢æˆ·ç«¯è·¯ç”±æ¡ä»¶:", href);
					return true;
				}
			}

			// åˆå§‹åŒ–å®¢æˆ·ç«¯è·¯ç”±ï¼ˆä»…åœ¨æ”¯æŒæ—¶ï¼‰
			let clientRouter = null;
			if (typeof window !== 'undefined' && 'history' in window && 'pushState' in history) {
				clientRouter = new ClientRouter();
				console.log("ğŸš€ å®¢æˆ·ç«¯è·¯ç”±ç³»ç»Ÿå·²å¯åŠ¨");
			} else {
				console.warn("âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå®¢æˆ·ç«¯è·¯ç”±ï¼Œä½¿ç”¨ä¼ ç»Ÿé¡µé¢è·³è½¬");
				// å›é€€åˆ°ä¼ ç»Ÿé“¾æ¥ç›‘å¬
				setupFallbackLinkListeners();
			}

			// ä¼ ç»Ÿé“¾æ¥ç›‘å¬ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
			function setupFallbackLinkListeners() {
				document.addEventListener("click", (e) => {
					const link = e.target.closest("a");
					if (!link || !link.href) return;

					const isInternalLink = link.href.startsWith(window.location.origin);
					const isHashLink = link.href.includes("#") && 
						link.href.split("#")[0] === window.location.href.split("#")[0];
					const isExternalLink = link.hasAttribute("target") && 
						link.getAttribute("target") === "_blank";

					if (isInternalLink && !isHashLink && !isExternalLink) {
						console.log("ä¼ ç»Ÿé¡µé¢è·³è½¬:", link.href);
						showPageLoader();
						setTimeout(hidePageLoader, 2000);
					}
				});

				window.addEventListener("popstate", () => {
					showPageLoader();
					setTimeout(hidePageLoader, 1000);
				});

				// ä¸ºç°æœ‰çš„å­èœå•ç»‘å®šäº‹ä»¶
				setTimeout(() => {
					bindInitialSubmenuEvents();
				}, 100);
			}

			// ä¸ºåˆå§‹é¡µé¢çš„å­èœå•ç»‘å®šäº‹ä»¶
			function bindInitialSubmenuEvents() {
				console.log("ğŸ”— åˆå§‹ç»‘å®šå­èœå•äº‹ä»¶");
				
				const itemGroups = document.querySelectorAll('.submenu-item-group');
				console.log("ğŸ”— åˆå§‹ç»‘å®šï¼šæ‰¾åˆ°èœå•é¡¹ç»„æ•°é‡:", itemGroups.length);
				
				itemGroups.forEach((itemGroup, index) => {
					const folderItem = itemGroup.querySelector('.submenu-folder-item');
					if (!folderItem) {
						console.log(`ğŸ”— åˆå§‹ç»‘å®šï¼šç¬¬ ${index + 1} ä¸ªç»„æ²¡æœ‰æ–‡ä»¶å¤¹é¡¹`);
						return;
					}
					
					const folderWrapper = folderItem.querySelector('.submenu-folder-wrapper');
					const expandArrow = folderItem.querySelector('.submenu-expand-arrow');
					const folderLink = folderItem.querySelector('.submenu-folder-link');
					const childrenContainer = itemGroup.querySelector('.submenu-children');
					
					console.log(`ğŸ”— åˆå§‹ç»‘å®šï¼šç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹:`, {
						hasWrapper: !!folderWrapper,
						hasArrow: !!expandArrow,
						hasLink: !!folderLink,
						hasContainer: !!childrenContainer,
						folderPath: folderItem.getAttribute('data-path')
					});
					
					if (expandArrow && childrenContainer && folderWrapper) {
						// ç®€åŒ–çš„åˆ‡æ¢å‡½æ•°
						const toggleExpansion = () => {
							const isExpanded = folderItem.classList.contains('expanded');
							console.log("ğŸ”„ åˆå§‹ç»‘å®šï¼šåˆ‡æ¢å±•å¼€çŠ¶æ€", {
								folderPath: decodeURIComponent(folderItem.getAttribute('data-path')),
								isExpanded,
								willExpand: !isExpanded
							});
							
							if (isExpanded) {
								folderItem.classList.remove('expanded');
								expandArrow.classList.remove('expanded');
								childrenContainer.style.display = 'none';
							} else {
								folderItem.classList.add('expanded');
								expandArrow.classList.add('expanded');
								childrenContainer.style.display = 'block';
							}
						};
						
						// ä¸ºç®­å¤´ç»‘å®šç‚¹å‡»äº‹ä»¶
						expandArrow.addEventListener('click', (e) => {
							console.log("ğŸ”— åˆå§‹ç»‘å®šï¼šç®­å¤´è¢«ç‚¹å‡»");
							e.preventDefault();
							e.stopPropagation();
							toggleExpansion();
						});
						
						// ä¸ºæ•´ä¸ªwrapperç»‘å®šç‚¹å‡»äº‹ä»¶
						folderWrapper.addEventListener('click', (e) => {
							// å¦‚æœç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œåˆ™ä¸å¤„ç†å±•å¼€é€»è¾‘
							if (e.target.closest('.submenu-folder-link')) {
								console.log("ğŸ”— åˆå§‹ç»‘å®šï¼šç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œä¸å¤„ç†å±•å¼€");
								return;
							}
							
							console.log("ğŸ”— åˆå§‹ç»‘å®šï¼šæ–‡ä»¶å¤¹åŒºåŸŸè¢«ç‚¹å‡»");
							e.preventDefault();
							e.stopPropagation();
							toggleExpansion();
						});
						
						console.log(`âœ… åˆå§‹ç»‘å®šï¼šç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹äº‹ä»¶ç»‘å®šå®Œæˆ`);
					} else {
						console.warn(`âš ï¸ åˆå§‹ç»‘å®šï¼šç¬¬ ${index + 1} ä¸ªæ–‡ä»¶å¤¹é¡¹ç¼ºå°‘å¿…è¦å…ƒç´ `);
					}
				});
			}

			// è¿”å›é¡¶éƒ¨åŠŸèƒ½
			function initBackToTop() {
				const backToTopButton = document.getElementById("back-to-top");
				if (!backToTopButton) return;

				window.addEventListener("scroll", () => {
					if (window.pageYOffset > 300) {
						backToTopButton.classList.remove("translate-y-20", "opacity-0");
						backToTopButton.classList.add("translate-y-0", "opacity-100");
				} else {
						backToTopButton.classList.add("translate-y-20", "opacity-0");
						backToTopButton.classList.remove("translate-y-0", "opacity-100");
					}
				});

				backToTopButton.addEventListener("click", () => {
					window.scrollTo({ top: 0, behavior: "smooth" });
				});
			}

			// ç”Ÿæˆé¢åŒ…å±‘å¯¼èˆª
			function generateBreadcrumb() {
				const breadcrumbNav = document.getElementById("breadcrumb-nav");
				if (!breadcrumbNav || !currentPath || currentPath === '/') return;

				const pathParts = currentPath.split("/").filter(Boolean);
				if (pathParts.length === 0) return;

				let html = '<ol class="flex items-center space-x-2 text-sm">';
				html += '<li><a href="/" class="text-gray-500 hover:text-gray-700">é¦–é¡µ</a></li>';

				let builtPath = "";
				pathParts.forEach((part, index) => {
					builtPath += "/" + part;
					const isLast = index === pathParts.length - 1;
					const menuItem = findMenuItemByPath(menuTree, builtPath);
					const label = menuItem ? menuItem.label : decodeURIComponent(part);

					html += `
						<li class="flex items-center">
							<svg class="w-4 h-4 mx-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
							</svg>
							${isLast 
								? `<span class="text-gray-700 font-medium">${label}</span>`
								: `<a href="${builtPath}" class="text-gray-500 hover:text-gray-700">${label}</a>`
							}
						</li>
					`;
				});

				html += '</ol>';
				breadcrumbNav.innerHTML = html;
			}

			// æŸ¥æ‰¾èœå•é¡¹
			function findMenuItemByPath(menuTree, targetPath) {
				function searchMenu(items) {
					for (const item of items) {
						if (item.path === targetPath) return item;
						if (item.children?.length > 0) {
							const found = searchMenu(item.children);
							if (found) return found;
						}
					}
					return null;
				}
				return searchMenu(menuTree);
			}

			// å…¶ä»–å…¨å±€åŠŸèƒ½
			function initGlobalFeatures() {
				// å¤–éƒ¨é“¾æ¥å¤„ç†
				document.querySelectorAll('a[href^="http"]').forEach((link) => {
					if (!link.href.startsWith(window.location.origin)) {
						link.setAttribute("target", "_blank");
						link.setAttribute("rel", "noopener noreferrer");
					}
				});

				// å¹³æ»‘æ»šåŠ¨
				document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
					anchor.addEventListener("click", function (e) {
						e.preventDefault();
						const target = document.querySelector(this.getAttribute("href"));
						if (target) {
							const headerHeight = document.querySelector("header")?.offsetHeight || 0;
							const targetPosition = target.offsetTop - headerHeight - 20;
							window.scrollTo({ top: targetPosition, behavior: "smooth" });
						}
					});
				});

				// åˆå§‹åŒ–å­èœå•äº‹ä»¶ç»‘å®š
				bindInitialSubmenuEvents();

				// ç¡®ä¿åˆå§‹é¡µé¢åŠ è½½æ—¶çš„æ­£ç¡®å±•å¼€çŠ¶æ€
				setTimeout(() => {
					ensureInitialExpansion();
					initializeActiveIndicators();
				}, 200);
			}

			// åˆå§‹åŒ– active æŒ‡ç¤ºå™¨ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
			function initializeActiveIndicators() {
				console.log("ğŸ¯ åˆå§‹åŒ– active æŒ‡ç¤ºå™¨");
				
				document.querySelectorAll('.submenu-children').forEach(container => {
					createInitialActiveIndicator(container);
				});
			}

			function createInitialActiveIndicator(container) {
				// ç§»é™¤ç°æœ‰çš„æŒ‡ç¤ºå™¨
				const existingIndicator = container.querySelector('.submenu-active-indicator');
				if (existingIndicator) {
					existingIndicator.remove();
				}

				// æŸ¥æ‰¾ active çš„å­é“¾æ¥
				const activeLinks = container.querySelectorAll('.submenu-child-link.active');
				if (activeLinks.length === 0) return;

				// ä¸ºæ¯ä¸ª active é“¾æ¥åˆ›å»ºæŒ‡ç¤ºå™¨
				activeLinks.forEach(activeLink => {
					const allLinks = Array.from(container.querySelectorAll('.submenu-child-link'));
					const index = allLinks.indexOf(activeLink);
					
					if (index !== -1) {
						// åˆ›å»ºæŒ‡ç¤ºå™¨å…ƒç´ 
						const indicator = document.createElement('div');
						indicator.className = 'submenu-active-indicator';
						
						// è®¡ç®—ä½ç½®
						const linkHeight = activeLink.offsetHeight;
						const linkTop = activeLink.offsetTop;
						
						// è®¾ç½®æŒ‡ç¤ºå™¨çš„ä½ç½®å’Œå°ºå¯¸
						indicator.style.top = `${linkTop}px`;
						indicator.style.height = `${linkHeight}px`;
						
						console.log("ğŸ¯ åˆå§‹åˆ›å»º active æŒ‡ç¤ºå™¨:", {
							index,
							linkHeight,
							linkTop
						});
						
						// æ·»åŠ åˆ°å®¹å™¨ä¸­
						container.appendChild(indicator);
					}
				});
			}

			// ç¡®ä¿åˆå§‹é¡µé¢çš„æ­£ç¡®å±•å¼€çŠ¶æ€
			function ensureInitialExpansion() {
				const currentPath = decodeURIComponent(window.location.pathname);
				console.log("ğŸ” åˆå§‹é¡µé¢å±•å¼€æ£€æŸ¥ï¼Œå½“å‰è·¯å¾„:", currentPath);
				
				// æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„ä¸»èœå•
				const activeMainMenu = document.querySelector('.main-menu-item.active');
				const mainMenuPath = activeMainMenu ? decodeURIComponent(activeMainMenu.getAttribute('data-path')) : null;
				
				// æ£€æŸ¥æ˜¯å¦é€šè¿‡ä¸€çº§ç›®å½•è¿›å…¥
				const isMainMenuAccess = currentPath === mainMenuPath;
				
				console.log("ğŸ” åˆå§‹è·¯å¾„åˆ†æ:", {
					currentPath,
					mainMenuPath,
					isMainMenuAccess
				});
				
				document.querySelectorAll('.submenu-folder-item').forEach(folderItem => {
					const folderPath = folderItem.getAttribute('data-path');
					const expandArrow = folderItem.querySelector('.submenu-expand-arrow');
					const itemGroup = folderItem.closest('.submenu-item-group');
					const childrenContainer = itemGroup ? itemGroup.querySelector('.submenu-children') : null;
					
					if (folderPath && childrenContainer) {
						const decodedFolderPath = decodeURIComponent(folderPath);
						
						let shouldExpand = false;
						
						if (isMainMenuAccess) {
							// å¦‚æœæ˜¯é€šè¿‡ä¸€çº§ç›®å½•è¿›å…¥ï¼Œå±•å¼€æ‰€æœ‰å­èœå•
							shouldExpand = true;
						} else {
							// å¦åˆ™åªå±•å¼€å½“å‰è·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¤¹
							shouldExpand = currentPath.startsWith(decodedFolderPath + '/') || 
										   currentPath === decodedFolderPath;
						}
						
						console.log("ğŸ” åˆå§‹å±•å¼€æ£€æŸ¥:", {
							folderPath: decodedFolderPath,
							currentPath,
							shouldExpand,
							reason: isMainMenuAccess ? 'ä¸€çº§ç›®å½•è¿›å…¥' : 'è·¯å¾„åŒ¹é…'
						});
						
						if (shouldExpand) {
							folderItem.classList.add('expanded');
							if (expandArrow) {
								expandArrow.classList.add('expanded');
							}
							childrenContainer.style.display = 'block';
							console.log("âœ… åˆå§‹å±•å¼€æ–‡ä»¶å¤¹:", decodedFolderPath);
						}
					}
				});
			}
		</script>
	</body>
</html>

<style is:global>
	/* å¯¼å…¥å…¨å±€æ ·å¼ */
	@import "../styles/global.css";

	/* åº”ç”¨å¸ƒå±€ */
	.app-layout {
		min-height: 100vh;
		background-color: var(--g-bg);
		display: flex;
		flex-direction: column;
	}

	/* ä¸»å¸ƒå±€ */
	.main-layout {
		display: block; /* æ”¹ä¸ºblockå¸ƒå±€ï¼Œå› ä¸ºä¾§è¾¹æ ç°åœ¨æ˜¯fixed */
		flex: 1;
		height: calc(100vh - 4rem);
	}

	.main-layout.no-header {
		height: 100vh;
	}



	/* ä¸»å†…å®¹åŒº */
	.main-content {
		margin-left: 16rem; /* ä¸ºå›ºå®šä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
		overflow-y: auto;
		overflow-x: hidden;
		background-color: var(--m-content-bg);
		height: 100%;
		/* Firefox æ»šåŠ¨æ¡æ ·å¼ */
		scrollbar-width: thin;
		scrollbar-color: var(--g-border) transparent;
		/* å¹³æ»‘æ»šåŠ¨ */
		scroll-behavior: smooth;
		/* åœ¨ iOS ä¸Šå¯ç”¨æƒ¯æ€§æ»šåŠ¨ */
		-webkit-overflow-scrolling: touch;
	}

	.main-content.full-width {
		margin-left: 0; /* æ— ä¾§è¾¹æ æ—¶å–æ¶ˆå·¦è¾¹è· */
		width: 100%;
	}

	/* ä¸»å†…å®¹åŒºæ»šåŠ¨æ¡æ ·å¼ */
	.main-content::-webkit-scrollbar {
		width: 6px;
	}

	.main-content::-webkit-scrollbar-track {
		background: transparent;
	}

	.main-content::-webkit-scrollbar-thumb {
		background: var(--g-border);
		border-radius: 3px;
		transition: background-color 0.2s ease;
	}

	.main-content::-webkit-scrollbar-thumb:hover {
		background: rgba(var(--color-primary), 0.6);
	}



	.content-container {
		padding: 1.5rem 2rem;
		max-width: none;
	}

	.content-area {
		max-width: none;
	}

	/* é¢åŒ…å±‘å¯¼èˆª */
	.breadcrumb-nav {
		margin-bottom: 1.5rem;
		padding-bottom: 1rem;
		border-bottom: 1px solid var(--b-crumb-border);
	}

	/* è¿”å›é¡¶éƒ¨æŒ‰é’® */
	#back-to-top {
		background: var(--btn-primary-bg);
		color: var(--btn-primary-text);
	}

	#back-to-top:hover {
		background: var(--btn-primary-bg-hover);
		transform: translateY(-1px) scale(1.05);
	}

	/* å“åº”å¼è®¾è®¡ */
	@media (max-width: 768px) {
		.content-container {
			padding: 1rem;
		}

		/* ç§»åŠ¨ç«¯ä¸»å†…å®¹åŒºåŸŸé€‚é… */
		.main-content {
			margin-left: 14rem; /* é€‚é…ç§»åŠ¨ç«¯ä¾§è¾¹æ å®½åº¦ */
		}

		.main-content.full-width {
			margin-left: 0;
		}

		/* ç§»åŠ¨ç«¯éšè—æ»šåŠ¨æ¡ä½†ä¿æŒåŠŸèƒ½ */
		.main-content::-webkit-scrollbar {
			width: 2px;
		}
	}

	@media (min-width: 1280px) {
		.content-container {
			padding: 2rem 3rem;
		}

		/* å¤§å±å¹•ä¸»å†…å®¹åŒºåŸŸé€‚é… */
		.main-content {
			margin-left: 18rem; /* é€‚é…å¤§å±å¹•ä¾§è¾¹æ å®½åº¦ */
		}

		.main-content.full-width {
			margin-left: 0;
		}
	}

	/* é¡µé¢ç±»å‹ç‰¹å®šæ ·å¼ */
	.app-layout[data-page-type="home"] {
		/* é¦–é¡µç‰¹å®šæ ·å¼ */
	}

	.app-layout[data-page-type="article"] {
		/* æ–‡ç« é¡µé¢ç‰¹å®šæ ·å¼ */
	}

	/* View Transitions é…ç½® - ç¦ç”¨æ‰€æœ‰åŠ¨ç”»ï¼Œä½¿ç”¨é¡¶éƒ¨åŠ è½½æ¡ */
	@view-transition {
		navigation: auto;
	}

	/* å®Œå…¨ç¦ç”¨æ‰€æœ‰ View Transitions åŠ¨ç”» */
	::view-transition-old(root),
	::view-transition-new(root) {
		animation: none;
	}

	/* é¡¶éƒ¨åŠ è½½è¿›åº¦æ¡ */
	.page-loader {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		height: 3px;
		z-index: 9999;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.2s ease-in-out;
	}

	.page-loader.loading {
		opacity: 1;
	}

	.page-loader-bar {
		height: 100%;
		background: linear-gradient(
			90deg,
			rgb(var(--color-primary)) 0%,
			rgba(251, 146, 60, 0.8) 50%,
			rgb(var(--color-primary)) 100%
		);
		border-radius: 0 2px 2px 0;
		position: relative;
		overflow: hidden;
		width: 0%;
		transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.page-loader-bar::after {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(
			90deg,
			transparent 0%,
			rgba(255, 255, 255, 0.4) 50%,
			transparent 100%
		);
		animation: shimmer 1.5s infinite;
	}

	@keyframes shimmer {
		0% {
			transform: translateX(-100%);
		}
		100% {
			transform: translateX(100%);
		}
	}

	/* é¡µé¢åˆ‡æ¢æ—¶çš„åé¦ˆ */
	.page-transitioning {
		cursor: wait;
	}

	.page-transitioning .main-content {
		pointer-events: none;
	}
	
	/* å®¢æˆ·ç«¯è·¯ç”±é¡µé¢åˆ‡æ¢æ•ˆæœ */
	.content-area {
		transition: opacity 0.2s ease, transform 0.2s ease;
	}
	
	.content-area.transitioning {
		opacity: 0.7;
		transform: translateY(10px);
	}
	
	/* ä¼˜åŒ–é“¾æ¥ç‚¹å‡»åé¦ˆ */
	a {
		transition: opacity 0.1s ease;
	}
	
	a:active {
		opacity: 0.7;
	}
	
	/* å®¢æˆ·ç«¯è·¯ç”±ä¸“ç”¨åŠ è½½çŠ¶æ€ */
	.client-routing-active {
		position: relative;
	}
	
	.client-routing-active::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(255, 255, 255, 0.1);
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.2s ease;
	}
	
	.client-routing-active.loading::before {
		opacity: 1;
	}

	/* ä¸»èœå•å­—ä½“æ ·å¼è°ƒæ•´ */
	.main-menu-item {
		font-size: 0.8125rem !important;
		font-weight: 500 !important;
	}

	.main-menu-text {
		font-size: inherit;
	}

	/* å­èœå•åŸºç¡€æ ·å¼ */
	.submenu-section {
		padding: 0;
		margin-top: 0.5rem;
	}

	.submenu-item-group {
		margin-bottom: 0.125rem;
	}

	/* æ–‡ä»¶å¤¹é¡¹æ ·å¼ï¼ˆä¸€çº§ç›®å½•ï¼‰ */
	.submenu-folder-item {
		position: relative;
		margin-bottom: 0.25rem;
	}

	.submenu-folder-wrapper {
		display: flex;
		align-items: center;
		padding: 0.625rem 1rem 0.625rem 0.75rem;
		border-radius: 0.375rem;
		transition: all 0.15s ease;
		cursor: pointer;
	}

	.submenu-folder-wrapper:hover {
		/* å–æ¶ˆèƒŒæ™¯è‰²ï¼Œåªä¿ç•™å­å…ƒç´ çš„é¢œè‰²å˜åŒ– */
	}

	.submenu-folder-item.active .submenu-folder-wrapper {
		/* å–æ¶ˆèƒŒæ™¯è‰²ï¼Œåªä¿ç•™å­å…ƒç´ çš„é¢œè‰²å˜åŒ– */
	}

	.submenu-folder-wrapper:active {
		/* å–æ¶ˆèƒŒæ™¯è‰²å’Œç¼©æ”¾æ•ˆæœ */
	}

	/* å±•å¼€æ”¶èµ·ç®­å¤´ï¼ˆå·¦ä¾§ï¼‰ */
	.submenu-expand-arrow {
		width: 1.75rem;
		height: 1.7rem;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--g-text-muted);
		transition: transform 0.2s ease, color 0.15s ease;
		cursor: pointer;
		margin-right: 0.5rem;
		border-radius: 0.25rem;
		padding: 0.125rem;
	}

	.submenu-expand-arrow:hover {
		color: rgb(var(--color-primary));
		background-color: rgba(251, 146, 60, 0.15);
		transform: scale(1.05);
	}

	.submenu-expand-arrow.expanded {
		transform: rotate(90deg);
		color: rgb(var(--color-primary));
	}

	.submenu-expand-arrow.expanded:hover {
		transform: rotate(90deg) scale(1.05);
	}

	.submenu-expand-arrow svg {
		width: 100%;
		height: 100%;
	}

	.submenu-folder-link {
		flex: 1;
		text-decoration: none;
		color: var(--g-text-primary);
		font-size: 0.9375rem;
		font-weight: 600;
		transition: all 0.2s ease;
	}

	.submenu-folder-link:hover {
		color: rgba(var(--color-primary), 0.8);
		text-decoration: underline;
		text-underline-offset: 3px;
		text-decoration-thickness: 1px;
		text-decoration-color: rgba(var(--color-primary), 0.6);
		transform: translateX(2px);
		/* fallback for older browsers */
		-webkit-text-decoration-line: underline;
		-webkit-text-underline-offset: 3px;
	}

	.submenu-folder-item.active .submenu-folder-link {
		color: rgb(var(--color-primary));
	}

	.submenu-folder-text {
		display: block;
	}

	/* æ–‡ç« é¡¹æ ·å¼ï¼ˆä¸€çº§ç›®å½•æ–‡ç« ï¼‰ */
	.submenu-article-link {
		display: flex;
		align-items: center;
		padding: 0.625rem 1rem 0.625rem 2.25rem;
		text-decoration: none;
		border-radius: 0.375rem;
		transition: all 0.2s ease;
		color: var(--g-text-primary);
		font-size: 0.9375rem;
		font-weight: 600;
		margin-bottom: 0.25rem;
	}

	.submenu-article-link:hover {
		color: rgba(var(--color-primary), 0.8);
		text-decoration: underline;
		text-underline-offset: 3px;
		text-decoration-thickness: 1px;
		text-decoration-color: rgba(var(--color-primary), 0.6);
		transform: translateX(2px);
		/* fallback for older browsers */
		-webkit-text-decoration-line: underline;
		-webkit-text-underline-offset: 3px;
	}

	.submenu-article-link.active {
		color: rgb(var(--color-primary));
	}

	.submenu-article-indicator {
		width: 4px;
		height: 4px;
		border-radius: 50%;
		background-color: var(--g-text-muted);
		margin-right: 0.75rem;
		transition: all 0.15s ease;
	}

	.submenu-article-link:hover .submenu-article-indicator {
		background-color: rgb(var(--color-primary));
		transform: scale(1.3);
	}

	.submenu-article-link.active .submenu-article-indicator {
		background-color: rgb(var(--color-primary));
		transform: scale(1.4);
		box-shadow: 0 0 6px rgba(251, 146, 60, 0.6);
	}

	.submenu-article-text {
		flex: 1;
	}

	/* å­é¡¹å®¹å™¨ï¼ˆäºŒçº§ç›®å½•ï¼‰ */
	.submenu-children {
		margin-left: 1.6rem;
		margin-top: 0.375rem;
		position: relative;
		border-left: 2px solid #e4e4e7;
		padding-left: 0.75rem;
		transition: border-left-color 0.15s ease;
	}

	/* å­é¡¹é“¾æ¥ï¼ˆäºŒçº§ç›®å½•ï¼‰ */
	.submenu-child-link {
		display: flex;
		align-items: center;
		padding: 0.5rem 0.75rem;
		text-decoration: none;
		border-radius: 0.375rem;
		transition: all 0.2s ease;
		color: var(--g-text-secondary);
		font-size: 0.875rem;
		font-weight: 500;
		margin-bottom: 0.25rem;
		position: relative;
	}

	.submenu-child-link:hover {
		color: rgba(var(--color-primary), 0.8);
		text-decoration: underline;
		text-underline-offset: 2px;
		text-decoration-thickness: 1px;
		text-decoration-color: rgba(var(--color-primary), 0.6);
		transform: translateX(1px);
		/* fallback for older browsers */
		-webkit-text-decoration-line: underline;
		-webkit-text-underline-offset: 2px;
	}

	.submenu-child-link.active {
		color: rgb(var(--color-primary));
		font-weight: 600;
	}

	/* Active æŒ‡ç¤ºå™¨ - å®šä½åˆ°å·¦ä¾§è¾¹æ¡†çº¿ä¸Š */
	.submenu-active-indicator {
		position: absolute;
		left: -2px; /* å®Œå…¨è¦†ç›–å·¦è¾¹æ¡† */
		width: 2px;
		background: rgb(var(--color-primary));
		z-index: 10;
	}

	/* å½“äºŒçº§ç›®å½•å®¹å™¨æ¿€æ´»æ—¶ï¼Œå·¦è¾¹æ¡†å˜ä¸ºæ©™è‰² */
	.submenu-children:has(.submenu-child-link.active) {
		border-left-color: var(--a-submenu-children-border-left);
	}

	.submenu-child-text {
		flex: 1;
		margin-left: 0.25rem;
	}

	/* ä¼˜åŒ–å­—ä½“æ¸²æŸ“ */
	.content-area {
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
		text-rendering: optimizeLegibility;
	}

	/* å‡å°‘åŠ¨ç”»ï¼ˆç”¨æˆ·åå¥½ï¼‰ */
	@media (prefers-reduced-motion: reduce) {
		*,
		*::before,
		*::after {
			animation-duration: 0.01ms !important;
			animation-iteration-count: 1 !important;
			transition-duration: 0.01ms !important;
			scroll-behavior: auto !important;
		}

		/* ä¸ºåå¥½å‡å°‘åŠ¨ç”»çš„ç”¨æˆ·ç¦ç”¨ View Transitions */
		::view-transition-old(root),
		::view-transition-new(root),
		::view-transition-old(main-content),
		::view-transition-new(main-content),
		::view-transition-old(content-area),
		::view-transition-new(content-area) {
			animation: none !important;
		}

		/* ç¦ç”¨é¡µé¢åˆ‡æ¢åé¦ˆ */
		.page-transitioning .content-area {
			opacity: 1 !important;
			transform: none !important;
			transition: none !important;
		}

		.content-area {
			transition: none !important;
		}
	}
</style>

